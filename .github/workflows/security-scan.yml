name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday at 2 AM

jobs:
  code-security:
    name: Code Security Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Run Trivy vulnerability scanner in repo mode
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'table'
        exit-code: '0'  # Don't fail the build on vulnerabilities

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'

    - name: Run Go Security Analysis
      run: |
        echo "Running Go security analysis..."
        
        # Use go vet for security analysis (built-in, always available)
        echo "1. Running go vet security checks..."
        go vet ./... || true
        
        # Check for common security issues manually
        echo "2. Checking for hardcoded secrets..."
        grep -r -i "password\|secret\|key\|token" --include="*.go" . || echo "No obvious hardcoded secrets found"
        
        echo "3. Checking for SQL injection patterns..."
        grep -r "fmt.Sprintf.*SELECT\|fmt.Sprintf.*INSERT\|fmt.Sprintf.*UPDATE\|fmt.Sprintf.*DELETE" --include="*.go" . || echo "No obvious SQL injection patterns found"
        
        echo "4. Checking for command injection patterns..."
        grep -r "exec.Command\|os.system\|cmd.Run" --include="*.go" . || echo "No command execution found"
        
        echo "Go security analysis completed"

    - name: Run Semgrep static analysis
      run: |
        echo "Installing and running Semgrep..."
        pip install semgrep
        semgrep --config=auto --json --output=semgrep-results.json . || true
        if [ -f semgrep-results.json ]; then
          echo "Semgrep scan completed. Results:"
          jq -r '.results[] | "\(.path):\(.start.line) - \(.message)"' semgrep-results.json || cat semgrep-results.json
        fi
      continue-on-error: true

    - name: Create security summary
      if: always()
      run: |
        echo "## ðŸ” Code Security Analysis Results" >> $GITHUB_STEP_SUMMARY
        echo "Security scans completed. Check the job logs for detailed results." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Tools used:**" >> $GITHUB_STEP_SUMMARY
        echo "- Trivy filesystem scanner" >> $GITHUB_STEP_SUMMARY
        echo "- Go vet security analysis" >> $GITHUB_STEP_SUMMARY
        echo "- Manual security pattern checks" >> $GITHUB_STEP_SUMMARY
        echo "- Semgrep static analysis" >> $GITHUB_STEP_SUMMARY

  dependency-check:
    name: Dependency Security Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version-file: 'go.mod'

    - name: Run Go vulnerability check
      run: |
        go install golang.org/x/vuln/cmd/govulncheck@latest
        govulncheck ./... || true  # Don't fail build on vulnerabilities

    - name: Run dependency vulnerability scanning with govulncheck
      run: |
        echo "Running comprehensive Go module vulnerability scan..."
        go mod tidy
        govulncheck -json ./... > vulns.json || true
        if [ -s vulns.json ]; then
          echo "Vulnerabilities found - see details below:"
          cat vulns.json
        else
          echo "No vulnerabilities found in direct dependencies"
        fi
        
    - name: Audit Go module dependencies
      run: |
        echo "Checking Go modules for known vulnerabilities..."
        go mod download
        echo "Direct dependencies:"
        go list -m all
        echo ""
        echo "Checking for outdated modules:"
        go list -u -m all || true
        
    - name: Create dependency summary
      if: always()
      run: |
        echo "## ðŸ“¦ Dependency Security Check Results" >> $GITHUB_STEP_SUMMARY
        echo "Dependency vulnerability scans completed." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Tools used:**" >> $GITHUB_STEP_SUMMARY
        echo "- govulncheck (Go vulnerability database)" >> $GITHUB_STEP_SUMMARY
        echo "- Go module dependency audit" >> $GITHUB_STEP_SUMMARY

  container-security:
    name: Container Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'schedule'
    continue-on-error: true  # Don't fail workflow if container scan fails
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Build image for scanning
      run: |
        docker build -t stock-exchange:scan .

    - name: Run Trivy vulnerability scanner on container
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'stock-exchange:scan'
        format: 'table'
        exit-code: '0'  # Don't fail build on vulnerabilities

    - name: Run Grype vulnerability scanner
      uses: anchore/scan-action@v3
      with:
        image: 'stock-exchange:scan'
        fail-build: false
        severity-cutoff: high
        
    - name: Docker Scout CVE analysis  
      run: |
        echo "Running basic container security checks..."
        docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
          aquasec/trivy:latest image stock-exchange:scan --exit-code 0 || true
        echo "Container security scan completed"
      continue-on-error: true
        
    - name: Create container security summary
      if: always()
      run: |
        echo "## ðŸ³ Container Security Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "Container vulnerability scans completed." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Tools used:**" >> $GITHUB_STEP_SUMMARY
        echo "- Trivy container scanner" >> $GITHUB_STEP_SUMMARY
        echo "- Grype vulnerability scanner" >> $GITHUB_STEP_SUMMARY
        echo "- Docker Scout CVE analysis" >> $GITHUB_STEP_SUMMARY

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [code-security, dependency-check]
    if: always()
    
    steps:
    - name: Security scan summary
      run: |
        echo "## ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Code Security | ${{ needs.code-security.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Dependencies | ${{ needs.dependency-check.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Container | Optional (runs on push/schedule) |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Note:** Security scans are configured to not fail builds." >> $GITHUB_STEP_SUMMARY
        echo "Review individual job logs for detailed vulnerability information." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**GitHub Advanced Security:** Not enabled - using alternative scanning tools." >> $GITHUB_STEP_SUMMARY