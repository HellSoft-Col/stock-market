name: Build Container with Buildah

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io

jobs:
  build:
    name: Build with Buildah
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      
    outputs:
      image: ${{ steps.image.outputs.image }}
      digest: ${{ steps.build.outputs.digest }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Set lowercase image name
      id: image_name
      run: |
        echo "name=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

    - name: Install Buildah
      run: |
        sudo apt-get update
        sudo apt-get install -y buildah podman

    - name: Log in to Container Registry
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ steps.image_name.outputs.name }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
          type=raw,value={{sha}},enable={{is_default_branch}}
          type=raw,value=stable,enable={{is_default_branch}}

    - name: Build container image with Buildah
      id: build
      run: |
        # Create a new container from base image
        CONTAINER=$(buildah from golang:1.25-alpine)
        echo "Created container: $CONTAINER"
        
        # Set working directory
        buildah config --workingdir /app $CONTAINER
        
        # Install dependencies in builder stage
        buildah run $CONTAINER -- apk --no-cache add ca-certificates tzdata git
        
        # Copy go mod files
        buildah copy $CONTAINER go.mod go.sum ./
        
        # Download dependencies
        buildah run $CONTAINER -- go mod download
        
        # Copy source code
        buildah copy $CONTAINER . .
        
        # Build the application
        buildah run $CONTAINER -- sh -c 'CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -ldflags="-w -s -extldflags \"-static\"" -o exchange-server ./cmd/server'
        
        # Create final image from distroless (root user for port 80 binding)
        FINAL_CONTAINER=$(buildah from gcr.io/distroless/static-debian12)
        
        # Set working directory first
        buildah config --workingdir /app $FINAL_CONTAINER
        
        # Copy certificates and timezone data
        buildah copy --from $CONTAINER $FINAL_CONTAINER /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/
        buildah copy --from $CONTAINER $FINAL_CONTAINER /usr/share/zoneinfo /usr/share/zoneinfo
        
        # Copy binary and configs to working directory
        buildah copy --from $CONTAINER $FINAL_CONTAINER /app/exchange-server /app/exchange-server
        buildah copy --from $CONTAINER $FINAL_CONTAINER /app/config.yaml /app/config.yaml
        buildah copy --from $CONTAINER $FINAL_CONTAINER /app/config.production.yaml /app/config.production.yaml
        
        # Copy web directory for static files (index.html)
        buildah copy --from $CONTAINER $FINAL_CONTAINER /app/web /app/web
        
        # Configure container
        buildah config --port 80 $FINAL_CONTAINER
        buildah config --env PORT=80 $FINAL_CONTAINER
        buildah config --entrypoint '[]' $FINAL_CONTAINER
        buildah config --cmd '["./exchange-server", "-config=./config.production.yaml"]' $FINAL_CONTAINER
        
        # Add labels
        buildah config --label org.opencontainers.image.source=https://github.com/${{ github.repository }} $FINAL_CONTAINER
        buildah config --label org.opencontainers.image.description="Stock Exchange Server for Teaching" $FINAL_CONTAINER
        buildah config --label org.opencontainers.image.revision=${{ github.sha }} $FINAL_CONTAINER
        
        # Commit the image
        IMAGE_ID=$(buildah commit $FINAL_CONTAINER ${{ env.REGISTRY }}/${{ steps.image_name.outputs.name }}:${{ github.sha }})
        echo "Built image: $IMAGE_ID"
        echo "digest=$IMAGE_ID" >> $GITHUB_OUTPUT
        
        # Tag with metadata
        echo '${{ steps.meta.outputs.tags }}' | while read -r tag; do
          if [ -n "$tag" ]; then
            echo "Tagging: $tag"
            buildah tag ${{ env.REGISTRY }}/${{ steps.image_name.outputs.name }}:${{ github.sha }} "$tag"
          fi
        done

    - name: Test container
      run: |
        # Test that the container can start and responds
        echo "Testing container startup..."
        
        # The Go application expects -config flag, not CONFIG_FILE env var
        # Let's override the default command to use the config flag
        CONTAINER_ID=$(podman run -d \
          -p 8080:80 \
          -e PORT=80 \
          -e ENV=production \
          ${{ env.REGISTRY }}/${{ steps.image_name.outputs.name }}:${{ github.sha }} \
          ./exchange-server -config=./config.yaml)
        
        echo "Container started with ID: $CONTAINER_ID"
        
        # Wait a moment for startup
        sleep 5
        
        # Check if container is still running
        if podman ps | grep -q "$CONTAINER_ID"; then
          echo "✅ Container is running successfully"
          echo "Container logs:"
          podman logs "$CONTAINER_ID" | head -20
        else
          echo "❌ Container failed to start"
          echo "Container logs:"
          podman logs "$CONTAINER_ID" || true
        fi
        
        # Clean up
        podman stop "$CONTAINER_ID" || true
        podman rm "$CONTAINER_ID" || true

    - name: Push to registry
      if: github.event_name != 'pull_request'
      id: push
      run: |
        echo '${{ steps.meta.outputs.tags }}' | while read -r tag; do
          if [ -n "$tag" ]; then
            echo "Pushing: $tag"
            buildah push "$tag"
          fi
        done

    - name: Output image
      id: image
      run: echo "image=${{ env.REGISTRY }}/${{ steps.image_name.outputs.name }}:${{ github.sha }}" >> $GITHUB_OUTPUT

  verify:
    name: Verify Build
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name != 'pull_request'
    
    steps:
    - name: Set image name
      id: image_name
      run: echo "name=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT
    - name: Install cosign
      uses: sigstore/cosign-installer@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Verify container image
      run: |
        VERIFY_IMAGE="${{ env.REGISTRY }}/${{ steps.image_name.outputs.name }}:latest"
        echo "Verifying image: $VERIFY_IMAGE"
        docker pull "$VERIFY_IMAGE"
        docker inspect "$VERIFY_IMAGE"

    - name: Generate SBOM
      uses: anchore/sbom-action@v0
      with:
        image: ${{ env.REGISTRY }}/${{ steps.image_name.outputs.name }}:latest
        format: spdx-json
        output-file: sbom.spdx.json

    - name: Upload SBOM
      uses: actions/upload-artifact@v4
      with:
        name: sbom
        path: sbom.spdx.json