name: Deploy to Azure

on:
  workflow_run:
    workflows: ["Build Container with Buildah"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io

jobs:
  deploy:
    name: Deploy to Azure
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
    - uses: actions/checkout@v5

    - name: Set deployment image
      id: image
      run: |
        IMAGE_NAME=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          TAG="latest"
        else
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          TAG="${{ github.ref_name }}-$SHORT_SHA"
        fi
        echo "image=${{ env.REGISTRY }}/$IMAGE_NAME:$TAG" >> $GITHUB_OUTPUT

    - name: Verify image exists
      run: |
        echo ${{ secrets.GITHUB_TOKEN }} | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin
        if ! docker manifest inspect "${{ steps.image.outputs.image }}" > /dev/null 2>&1; then
          echo "‚ùå Image not found: ${{ steps.image.outputs.image }}"
          exit 1
        fi
        echo "‚úÖ Image verified: ${{ steps.image.outputs.image }}"

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Setup Log Analytics Workspace
      run: |
        RESOURCE_GROUP="${{ vars.AZURE_RESOURCE_GROUP || 'trading-course-rg' }}"
        WORKSPACE_NAME="${{ vars.LOG_ANALYTICS_WORKSPACE || 'trading-course-logs' }}"
        LOCATION="${{ vars.AZURE_LOCATION || 'eastus' }}"
        
        # Create Log Analytics workspace
        az monitor log-analytics workspace create \
          --resource-group "$RESOURCE_GROUP" \
          --workspace-name "$WORKSPACE_NAME" \
          --location "$LOCATION" \
          --sku PerGB2018 \
          --only-show-errors || echo "Workspace already exists"
        
        # Get workspace ID
        WORKSPACE_ID=$(az monitor log-analytics workspace show \
          --resource-group "$RESOURCE_GROUP" \
          --workspace-name "$WORKSPACE_NAME" \
          --query customerId \
          --output tsv)
        
        if [ -n "$WORKSPACE_ID" ] && [ "$WORKSPACE_ID" != "null" ]; then
          echo "‚úÖ Log Analytics Workspace ready: $WORKSPACE_ID"
          echo "LOG_ANALYTICS_WORKSPACE_ID=$WORKSPACE_ID" >> $GITHUB_ENV
        else
          echo "‚ùå Failed to get Log Analytics workspace ID"
          exit 1
        fi

    - name: Deploy Container
      run: |
        RESOURCE_GROUP="${{ vars.AZURE_RESOURCE_GROUP || 'trading-course-rg' }}"
        CONTAINER_NAME="${{ vars.AZURE_CONTAINER_NAME || 'trading-course' }}"
        
        az container delete --resource-group "$RESOURCE_GROUP" --name "$CONTAINER_NAME" --yes || true
        sleep 10
        
        az container create \
          --resource-group "$RESOURCE_GROUP" \
          --name "$CONTAINER_NAME" \
          --image "${{ steps.image.outputs.image }}" \
          --location "${{ vars.AZURE_LOCATION || 'eastus' }}" \
          --dns-name-label "$CONTAINER_NAME" \
          --os-type Linux \
          --ports 80 \
          --cpu ${{ vars.CPU_CORES || 0.5 }} \
          --memory ${{ vars.MEMORY_GB || 1 }} \
          --restart-policy Always \
          --environment-variables PORT=80 LOG_LEVEL=${{ vars.LOG_LEVEL || 'info' }} ENV=production \
          --secure-environment-variables MONGODB_URI='${{ secrets.MONGODB_URI }}' \
          --registry-login-server '${{ env.REGISTRY }}' \
          --registry-username '${{ github.actor }}' \
          --registry-password '${{ secrets.GHCR_PAT }}' \
          --log-analytics-workspace '${{ env.LOG_ANALYTICS_WORKSPACE_ID }}'

    - name: Health check
      run: |
        CONTAINER_NAME="${{ vars.AZURE_CONTAINER_NAME || 'trading-course' }}"
        RESOURCE_GROUP="${{ vars.AZURE_RESOURCE_GROUP || 'trading-course-rg' }}"
        
        sleep 30
        for i in {1..3}; do
          STATE=$(az container show --resource-group "$RESOURCE_GROUP" --name "$CONTAINER_NAME" --query 'instanceView.state' --output tsv)
          
          if [ "$STATE" = "Running" ]; then
            echo "‚úÖ Container is running"
            INFO=$(az container show --resource-group "$RESOURCE_GROUP" --name "$CONTAINER_NAME" --query '{fqdn: ipAddress.fqdn, ip: ipAddress.ip}' --output json)
            IP=$(echo "$INFO" | jq -r '.ip')
            FQDN=$(echo "$INFO" | jq -r '.fqdn')
            echo "Container IP: $IP"
            echo "Container FQDN: $FQDN"
            echo "CONTAINER_IP=$IP" >> $GITHUB_ENV
            echo "CONTAINER_FQDN=$FQDN" >> $GITHUB_ENV
            break
          elif [ "$STATE" = "Failed" ]; then
            echo "‚ùå Container failed"
            az container logs --resource-group "$RESOURCE_GROUP" --name "$CONTAINER_NAME" --tail 20
            exit 1
          fi
          
          echo "Waiting... ($i/3)"
          sleep 15
        done

    - name: Update Cloudflare DNS
      if: env.CONTAINER_IP != '' && env.CONTAINER_IP != 'null'
      run: |
        ZONE_ID="${{ secrets.CLOUDFLARE_ZONE_ID }}"
        API_TOKEN="${{ secrets.CLOUDFLARE_API_TOKEN }}"
        DOMAIN_NAME="trading.hellsoft.tech"
        
        if [ -z "$ZONE_ID" ] || [ -z "$API_TOKEN" ]; then
          echo "Cloudflare credentials not configured - skipping DNS update"
          exit 0
        fi
        
        RECORD_ID=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/dns_records?type=A&name=$DOMAIN_NAME" \
          -H "Authorization: Bearer $API_TOKEN" \
          -H "Content-Type: application/json" | jq -r '.result[0].id // empty')
        
        if [ -n "$RECORD_ID" ] && [ "$RECORD_ID" != "null" ]; then
          curl -s -X PUT "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/dns_records/$RECORD_ID" \
            -H "Authorization: Bearer $API_TOKEN" \
            -H "Content-Type: application/json" \
            --data '{"type": "A", "name": "'$DOMAIN_NAME'", "content": "'${{ env.CONTAINER_IP }}'", "ttl": 1, "proxied": true}'
          echo "‚úÖ DNS record updated: $DOMAIN_NAME -> ${{ env.CONTAINER_IP }}"
        else
          curl -s -X POST "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/dns_records" \
            -H "Authorization: Bearer $API_TOKEN" \
            -H "Content-Type: application/json" \
            --data '{"type": "A", "name": "'$DOMAIN_NAME'", "content": "'${{ env.CONTAINER_IP }}'", "ttl": 1, "proxied": true}'
          echo "‚úÖ DNS record created: $DOMAIN_NAME -> ${{ env.CONTAINER_IP }}"
        fi

    - name: Verify deployment and logging
      run: |
        CONTAINER_NAME="${{ vars.AZURE_CONTAINER_NAME || 'trading-course' }}"
        RESOURCE_GROUP="${{ vars.AZURE_RESOURCE_GROUP || 'trading-course-rg' }}"
        
        # Check Log Analytics integration
        LOGGING_CONFIG=$(az container show \
          --resource-group "$RESOURCE_GROUP" \
          --name "$CONTAINER_NAME" \
          --query 'properties.diagnostics.logAnalytics.workspaceId' \
          --output tsv 2>/dev/null || echo "none")
        
        echo "üéâ DEPLOYMENT COMPLETE"
        echo "‚úÖ Container: $CONTAINER_NAME"
        echo "‚úÖ Direct access: http://${{ env.CONTAINER_FQDN }}"
        echo "‚úÖ HTTPS access: https://trading.hellsoft.tech"
        echo "‚úÖ WebSocket: wss://trading.hellsoft.tech/ws"
        
        if [ "$LOGGING_CONFIG" != "none" ] && [ "$LOGGING_CONFIG" != "null" ] && [ -n "$LOGGING_CONFIG" ]; then
          echo "‚úÖ Log Analytics: Integrated ($LOGGING_CONFIG)"
          echo ""
          echo "üìä View logs in Azure Portal:"
          echo "1. Go to Azure Portal ‚Üí Container Instances"
          echo "2. Select '$CONTAINER_NAME'"
          echo "3. Click 'Logs' in the left sidebar"
          echo "4. Use query: ContainerInstanceLog_CL | order by TimeGenerated desc"
        else
          echo "‚ö†Ô∏è  Log Analytics: Not detected"
          echo "Logs available via CLI: az container logs --resource-group $RESOURCE_GROUP --name $CONTAINER_NAME"
        fi



  rollback:
    name: Rollback on failure
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    
    steps:
    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Set rollback image name
      id: rollback_image
      run: echo "name=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

    - name: Rollback to stable image
      run: |
        echo "Deployment failed, attempting rollback to stable..."
        
        # Try to use stable tag first, fallback to latest
        ROLLBACK_IMAGE="${{ env.REGISTRY }}/${{ steps.rollback_image.outputs.name }}:stable"
        
        # Verify stable image exists
        if ! docker manifest inspect "$ROLLBACK_IMAGE" > /dev/null 2>&1; then
          echo "Stable image not found, using latest..."
          ROLLBACK_IMAGE="${{ env.REGISTRY }}/${{ steps.rollback_image.outputs.name }}:latest"
        fi
        
        echo "Rolling back to: $ROLLBACK_IMAGE"
        
        # Generate rollback deployment config
        cat > rollback-deployment.json << EOF
        {
          "apiVersion": "2021-10-01",
          "location": "${{ vars.AZURE_LOCATION || 'eastus' }}",
          "name": "${{ vars.AZURE_CONTAINER_NAME || 'trading-course' }}",
          "properties": {
            "containers": [
              {
                "name": "trading-app",
                "properties": {
                  "image": "$ROLLBACK_IMAGE",
                   "command": ["./exchange-server", "-config=./config.production.yaml"],
                   "ports": [
                     {
                       "protocol": "TCP",
                       "port": 80
                     }
                   ],
                   "environmentVariables": [
                     {
                       "name": "MONGODB_URI",
                       "secureValue": "${{ secrets.MONGODB_URI }}"
                     },
                     {
                       "name": "PORT", 
                       "value": "80"
                     },
                     {
                       "name": "ENV",
                       "value": "production"
                     }
                   ],
                  "resources": {
                    "requests": {
                      "memoryInGB": ${{ vars.MEMORY_GB || 1 }},
                      "cpu": ${{ vars.CPU_CORES || 0.5 }}
                    }
                  }
                }
              }
            ],
            "imageRegistryCredentials": [
              {
                "server": "${{ env.REGISTRY }}",
                "username": "${{ github.actor }}",
                "password": "${{ secrets.GHCR_PAT }}"
              }
            ],
            "ipAddress": {
              "type": "Public",
               "ports": [
                 {
                   "protocol": "TCP",
                   "port": 80
                 }
               ],
              "dnsNameLabel": "${{ vars.AZURE_CONTAINER_NAME || 'trading-course' }}"
            },
            "osType": "Linux",
            "restartPolicy": "Always"
          },
          "type": "Microsoft.ContainerInstance/containerGroups"
        }
        EOF
        
        # Delete failed container and deploy rollback
        az container delete \
          --resource-group ${{ vars.AZURE_RESOURCE_GROUP || 'trading-course-rg' }} \
          --name ${{ vars.AZURE_CONTAINER_NAME || 'trading-course' }} \
          --yes || true
        
        sleep 10
        
        # Get Log Analytics workspace ID for rollback
        WORKSPACE_ID=$(az monitor log-analytics workspace show \
          --resource-group ${{ vars.AZURE_RESOURCE_GROUP || 'trading-course-rg' }} \
          --workspace-name ${{ vars.LOG_ANALYTICS_WORKSPACE || 'trading-course-logs' }} \
          --query customerId \
          --output tsv 2>/dev/null || echo "")
        
        if [ -n "$WORKSPACE_ID" ] && [ "$WORKSPACE_ID" != "null" ]; then
          az container create \
            --resource-group ${{ vars.AZURE_RESOURCE_GROUP || 'trading-course-rg' }} \
            --file rollback-deployment.json \
            --log-analytics-workspace "$WORKSPACE_ID" || echo "‚ùå Rollback failed"
        else
          az container create \
            --resource-group ${{ vars.AZURE_RESOURCE_GROUP || 'trading-course-rg' }} \
            --file rollback-deployment.json || echo "‚ùå Rollback failed"
        fi