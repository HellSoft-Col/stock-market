name: Deploy Teacher Trading Server

on:
  workflow_run:
    workflows: ["Build Container with Buildah"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    name: Deploy Cost-Optimized Trading Server
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Log in to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Get image tag
      id: image
      run: |
        IMAGE_TAG=${{ github.sha }}
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          IMAGE_TAG="latest"
        fi
        echo "tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
        echo "image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$IMAGE_TAG" >> $GITHUB_OUTPUT

    - name: Generate teacher-optimized configuration
      id: config
      run: |
        # Create deployment YAML optimized for teacher budget
        cat > deployment.yaml << EOF
        apiVersion: '2021-10-01'
        location: ${{ vars.AZURE_LOCATION || 'eastus' }}
        name: ${{ vars.AZURE_CONTAINER_NAME || 'trading-course' }}
        properties:
          containers:
          - name: ${{ vars.AZURE_CONTAINER_NAME || 'trading-course' }}
            properties:
              image: ${{ steps.image.outputs.image }}
              ports:
              - protocol: TCP
                port: ${{ vars.CONTAINER_PORT || 80 }}
              environmentVariables:
              - name: 'MONGODB_URI'
                secureValue: '${{ secrets.MONGODB_URI }}'
              - name: 'CONFIG_FILE'
                value: '${{ vars.CONFIG_FILE || '/config.production.yaml' }}'
              - name: 'PORT'
                value: '${{ vars.CONTAINER_PORT || '80' }}'
              - name: 'LOG_LEVEL'
                value: '${{ vars.LOG_LEVEL || 'info' }}'
              - name: 'ENVIRONMENT'
                value: '${{ vars.ENVIRONMENT || 'teacher-course' }}'
              - name: 'MAX_CONNECTIONS'
                value: '${{ vars.MAX_CONNECTIONS || '30' }}'
              resources:
                requests:
                  memoryInGB: ${{ vars.MEMORY_GB || 1 }}
                  cpu: ${{ vars.CPU_CORES || 0.5 }}
          imageRegistryCredentials:
          - server: ${{ env.REGISTRY }}
            username: ${{ github.actor }}
            password: ${{ secrets.GITHUB_TOKEN }}
          ipAddress:
            type: Public
            ports:
            - protocol: TCP
              port: ${{ vars.CONTAINER_PORT || 80 }}
            dnsNameLabel: ${{ vars.DNS_LABEL || vars.AZURE_CONTAINER_NAME || 'trading-course' }}
          osType: Linux
          restartPolicy: Always
        tags:
          Environment: '${{ vars.ENVIRONMENT || 'teacher-course' }}'
          Project: 'stock-exchange-teaching'
          CostOptimized: 'true'
          Duration: '3-weeks'
          ManagedBy: 'github-actions'
          Teacher: '${{ github.actor }}'
        type: Microsoft.ContainerInstance/containerGroups
        EOF
        
        echo "âœ… Generated teacher cost-optimized deployment configuration"
        echo "ðŸ’° Configuration: ${{ vars.CPU_CORES || 0.5 }} vCPU, ${{ vars.MEMORY_GB || 1 }} GB RAM"

    - name: Deploy trading server for students
      run: |
        echo "ðŸŽ“ Deploying cost-optimized trading server for students..."
        echo "ðŸ’° Cost: ~$12-15 for 3 weeks with ${{ vars.CPU_CORES || 0.5 }} vCPU, ${{ vars.MEMORY_GB || 1 }} GB RAM"
        
        # Delete existing container group if it exists
        az container delete \
          --resource-group ${{ vars.AZURE_RESOURCE_GROUP || 'trading-course-rg' }} \
          --name ${{ vars.AZURE_CONTAINER_NAME || 'trading-course' }} \
          --yes || echo "No existing container to delete"

        # Wait for cleanup
        sleep 15

        # Deploy using YAML file
        az container create \
          --resource-group ${{ vars.AZURE_RESOURCE_GROUP || 'trading-course-rg' }} \
          --file deployment.yaml

        echo "âœ… Teacher's trading server deployment initiated"

    - name: Wait for deployment and health check
      run: |
        echo "â³ Waiting for trading server to be ready for students..."
        
        CONTAINER_NAME="${{ vars.AZURE_CONTAINER_NAME || 'trading-course' }}"
        RESOURCE_GROUP="${{ vars.AZURE_RESOURCE_GROUP || 'trading-course-rg' }}"
        
        # Wait up to 6 minutes for container to be running
        for i in {1..36}; do
          STATE=$(az container show \
            --resource-group "$RESOURCE_GROUP" \
            --name "$CONTAINER_NAME" \
            --query 'instanceView.state' \
            --output tsv 2>/dev/null || echo "NotFound")
          
          echo "Trading server state: $STATE (attempt $i/36)"
          
          if [ "$STATE" = "Running" ]; then
            echo "âœ… Trading server is running and ready for students!"
            break
          elif [ "$STATE" = "Failed" ] || [ "$STATE" = "Terminated" ]; then
            echo "âŒ Trading server failed. Checking logs..."
            az container logs \
              --resource-group "$RESOURCE_GROUP" \
              --name "$CONTAINER_NAME" || true
            exit 1
          fi
          
          sleep 10
        done

    - name: Get deployment information
      id: deployment
      run: |
        CONTAINER_NAME="${{ vars.AZURE_CONTAINER_NAME || 'trading-course' }}"
        RESOURCE_GROUP="${{ vars.AZURE_RESOURCE_GROUP || 'trading-course-rg' }}"
        
        # Get container details
        CONTAINER_INFO=$(az container show \
          --resource-group "$RESOURCE_GROUP" \
          --name "$CONTAINER_NAME" \
          --query '{fqdn: ipAddress.fqdn, ip: ipAddress.ip, state: instanceView.state, restartCount: instanceView.restartCount}' \
          --output json)
        
        FQDN=$(echo "$CONTAINER_INFO" | jq -r '.fqdn // "N/A"')
        IP=$(echo "$CONTAINER_INFO" | jq -r '.ip // "N/A"')
        STATE=$(echo "$CONTAINER_INFO" | jq -r '.state // "Unknown"')
        RESTART_COUNT=$(echo "$CONTAINER_INFO" | jq -r '.restartCount // 0')
        
        echo "fqdn=$FQDN" >> $GITHUB_OUTPUT
        echo "ip=$IP" >> $GITHUB_OUTPUT
        echo "state=$STATE" >> $GITHUB_OUTPUT
        echo "restart_count=$RESTART_COUNT" >> $GITHUB_OUTPUT

    - name: Test trading server
      run: |
        FQDN="${{ steps.deployment.outputs.fqdn }}"
        PORT="${{ vars.CONTAINER_PORT || 80 }}"
        
        if [ "$FQDN" != "N/A" ]; then
          URL="http://$FQDN:$PORT"
          echo "ðŸ§ª Testing trading server at: $URL"
          
          # Health check for the trading platform
          curl --max-time 30 --retry 3 --retry-delay 10 \
            --fail --silent --show-error "$URL" > /dev/null && \
            echo "âœ… Trading server health check passed - ready for students!" || \
            echo "âš ï¸ Health check failed (server might still be starting up)"
        fi

    - name: Generate teacher summary
      run: |
        echo "## ðŸŽ“ Trading Server Deployed for Students!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Server Information" >> $GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| **Student URL** | [http://${{ steps.deployment.outputs.fqdn }}](http://${{ steps.deployment.outputs.fqdn }}) |" >> $GITHUB_STEP_SUMMARY
        echo "| **Server Status** | ${{ steps.deployment.outputs.state }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Resources** | ${{ vars.CPU_CORES || 0.5 }} vCPU, ${{ vars.MEMORY_GB || 1 }} GB RAM |" >> $GITHUB_STEP_SUMMARY
        echo "| **Max Students** | ~${{ vars.MAX_CONNECTIONS || 30 }} concurrent |" >> $GITHUB_STEP_SUMMARY
        echo "| **Restart Count** | ${{ steps.deployment.outputs.restart_count }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Environment** | ${{ vars.ENVIRONMENT || 'teacher-course' }} |" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.deployment.outputs.ip }}" != "N/A" ]; then
          echo "| **IP Address** | \`${{ steps.deployment.outputs.ip }}\` |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ‘¨â€ðŸŽ“ Share with Students" >> $GITHUB_STEP_SUMMARY
        echo "**Trading Platform URL:**" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "http://${{ steps.deployment.outputs.fqdn }}" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ’° Cost Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Daily cost**: ~$0.60" >> $GITHUB_STEP_SUMMARY
        echo "- **Weekly cost**: ~$4-5" >> $GITHUB_STEP_SUMMARY
        echo "- **3-week total**: ~$12-15" >> $GITHUB_STEP_SUMMARY
        echo "- **Per student**: ~$0.40-0.50 each" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”§ Teacher Management Commands" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "# Monitor student activity (real-time logs)" >> $GITHUB_STEP_SUMMARY
        echo "az container logs --resource-group ${{ vars.AZURE_RESOURCE_GROUP || 'trading-course-rg' }} --name ${{ vars.AZURE_CONTAINER_NAME || 'trading-course' }} --follow" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# Restart server if needed during class" >> $GITHUB_STEP_SUMMARY
        echo "az container restart --resource-group ${{ vars.AZURE_RESOURCE_GROUP || 'trading-course-rg' }} --name ${{ vars.AZURE_CONTAINER_NAME || 'trading-course' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# Check server status" >> $GITHUB_STEP_SUMMARY
        echo "az container show --resource-group ${{ vars.AZURE_RESOURCE_GROUP || 'trading-course-rg' }} --name ${{ vars.AZURE_CONTAINER_NAME || 'trading-course' }}" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  cost-notification:
    name: Cost Tracking Notification
    runs-on: ubuntu-latest
    needs: deploy
    if: success()
    
    steps:
    - name: Cost tracking summary
      run: |
        echo "## ðŸ’° Cost Tracking Update" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Your cost-optimized trading server is now running:" >> $GITHUB_STEP_SUMMARY
        echo "- **Configuration**: ${{ vars.CPU_CORES || 0.5 }} vCPU, ${{ vars.MEMORY_GB || 1 }} GB RAM" >> $GITHUB_STEP_SUMMARY
        echo "- **Estimated daily cost**: ~$0.60" >> $GITHUB_STEP_SUMMARY
        echo "- **Estimated 3-week cost**: ~$12-15 total" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Š Monitor costs in Azure Portal: **Cost Management + Billing**" >> $GITHUB_STEP_SUMMARY