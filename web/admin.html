<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ”´ Admin Dashboard - Stock Exchange</title>
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ”´</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                        'mono': ['JetBrains Mono', 'monospace']
                    },
                    colors: {
                        admin: {
                            50: '#fef2f2',
                            100: '#fee2e2',
                            500: '#ef4444',
                            600: '#dc2626',
                            700: '#b91c1c',
                            900: '#7f1d1d'
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        .admin-gradient {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        .status-connected { background: #10b981; }
        .status-disconnected { background: #ef4444; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="h-full bg-gray-50 font-sans">
    <!-- Header -->
    <header class="admin-gradient text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <span class="text-3xl">ðŸ”´</span>
                    <div>
                        <h1 class="text-2xl font-bold">Admin Dashboard</h1>
                        <p class="text-sm text-red-100">Stock Exchange Control Center</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="connection-status" class="flex items-center">
                        <span class="status-dot status-disconnected"></span>
                        <span id="status-text">Disconnected</span>
                    </div>
                    <button onclick="logout()" class="bg-red-800 hover:bg-red-900 px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-6">
        <!-- Stats Overview -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-6 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Active Users</p>
                        <p id="stat-users" class="text-3xl font-bold text-gray-900">0</p>
                    </div>
                    <div class="text-4xl text-red-600">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Active Orders</p>
                        <p id="stat-orders" class="text-3xl font-bold text-gray-900">0</p>
                    </div>
                    <div class="text-4xl text-blue-600">
                        <i class="fas fa-file-invoice"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Total Volume</p>
                        <p id="stat-volume" class="text-3xl font-bold text-gray-900">$0</p>
                    </div>
                    <div class="text-4xl text-green-600">
                        <i class="fas fa-chart-line"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Total Trades</p>
                        <p id="stat-trades" class="text-3xl font-bold text-gray-900">0</p>
                    </div>
                    <div class="text-4xl text-purple-600">
                        <i class="fas fa-exchange-alt"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Debug Mode Control -->
        <div class="bg-white rounded-lg shadow mb-6">
            <div class="p-6">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                            <i class="fas fa-bug text-yellow-600 mr-3"></i>
                            Debug Mode Control
                        </h3>
                        <p class="text-sm text-gray-600 mt-1">
                            Global toggle for development and testing features
                        </p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-right">
                            <div class="text-sm text-gray-600">Current Status:</div>
                            <div id="debug-mode-status" class="text-2xl font-bold">
                                <span class="text-gray-400">Loading...</span>
                            </div>
                        </div>
                        <button onclick="toggleDebugMode()" id="toggle-debug-btn" 
                                class="px-6 py-3 rounded-lg font-medium transition-all shadow-sm hover:shadow-md">
                            <i class="fas fa-sync mr-2"></i>Toggle Mode
                        </button>
                    </div>
                </div>
                
                <!-- Info Section -->
                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="border border-green-200 rounded-lg p-4 bg-green-50">
                        <h4 class="font-semibold text-green-900 mb-2 flex items-center">
                            <i class="fas fa-check-circle text-green-600 mr-2"></i>
                            When ENABLED
                        </h4>
                        <ul class="text-sm text-green-800 space-y-1">
                            <li>â€¢ <code>AUTO_ACCEPT</code> orders fill instantly</li>
                            <li>â€¢ Error injection available for testing</li>
                            <li>â€¢ Production simulation enabled</li>
                            <li>â€¢ Web UI debug features visible</li>
                        </ul>
                    </div>
                    <div class="border border-red-200 rounded-lg p-4 bg-red-50">
                        <h4 class="font-semibold text-red-900 mb-2 flex items-center">
                            <i class="fas fa-ban text-red-600 mr-2"></i>
                            When DISABLED (Production Mode)
                        </h4>
                        <ul class="text-sm text-red-800 space-y-1">
                            <li>â€¢ All debug requests rejected</li>
                            <li>â€¢ <code>AUTO_ACCEPT</code> orders return errors</li>
                            <li>â€¢ Debug features hidden from UI</li>
                            <li>â€¢ Normal market operations only</li>
                        </ul>
                    </div>
                </div>
                
                <!-- Change History -->
                <div class="mt-4 border border-gray-200 rounded-lg p-4 bg-gray-50" id="debug-mode-history">
                    <div class="flex items-center justify-between text-sm text-gray-600">
                        <div>
                            <i class="fas fa-history mr-2"></i>
                            Last changed: <span id="debug-last-changed" class="font-medium">Never</span>
                        </div>
                        <div>
                            Changed by: <span id="debug-changed-by" class="font-medium">N/A</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="bg-white rounded-lg shadow mb-6">
            <div class="border-b border-gray-200">
                <nav class="flex space-x-8 px-6" aria-label="Tabs">
                    <button onclick="switchTab('overview')" id="tab-overview" class="admin-tab border-b-2 border-red-600 text-red-600 py-4 px-1 text-sm font-medium">
                        <i class="fas fa-dashboard mr-2"></i>Overview
                    </button>
                    <button onclick="switchTab('teams')" id="tab-teams" class="admin-tab border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 text-sm font-medium">
                        <i class="fas fa-users-cog mr-2"></i>Team Management
                    </button>
                </nav>
            </div>
        </div>

        <!-- Overview Tab Content -->
        <div id="content-overview" class="tab-content">
        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Connected Users -->
            <div class="bg-white rounded-lg shadow">
                <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                    <h2 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-users text-red-600 mr-2"></i>Connected Users
                    </h2>
                    <button onclick="refreshSessions()" class="text-sm text-red-600 hover:text-red-700">
                        <i class="fas fa-sync-alt mr-1"></i>Refresh
                    </button>
                </div>
                <div id="users-list" class="p-4 max-h-96 overflow-y-auto">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-users text-4xl mb-2"></i>
                        <p>No users connected</p>
                    </div>
                </div>
            </div>

            <!-- Team P&L -->
            <div class="bg-white rounded-lg shadow">
                <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                    <h2 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-chart-pie text-red-600 mr-2"></i>Team Performance
                    </h2>
                    <button onclick="refreshPerformance()" class="text-sm text-red-600 hover:text-red-700">
                        <i class="fas fa-sync-alt mr-1"></i>Refresh
                    </button>
                </div>
                <div id="performance-list" class="p-4 max-h-96 overflow-y-auto">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-chart-line text-4xl mb-2"></i>
                        <p>Loading performance data...</p>
                    </div>
                </div>
            </div>

            <!-- Market Overview -->
            <div class="bg-white rounded-lg shadow">
                <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                    <h2 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-chart-bar text-red-600 mr-2"></i>Market Overview
                    </h2>
                    <button onclick="refreshMarket()" class="text-sm text-red-600 hover:text-red-700">
                        <i class="fas fa-sync-alt mr-1"></i>Refresh
                    </button>
                </div>
                <div id="market-overview" class="p-4">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-chart-area text-4xl mb-2"></i>
                        <p>Loading market data...</p>
                    </div>
                </div>
            </div>

            <!-- Admin Controls -->
            <div class="bg-white rounded-lg shadow">
                <div class="p-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-cog text-red-600 mr-2"></i>Admin Controls
                    </h2>
                </div>
                <div class="p-4 space-y-3">
                    <button onclick="showCreateOrderModal()" class="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-3 rounded-lg transition-colors">
                        <i class="fas fa-plus-circle mr-2"></i>Create Order
                    </button>
                    <button onclick="cancelAllOrders()" class="w-full bg-orange-600 hover:bg-orange-700 text-white px-4 py-3 rounded-lg transition-colors">
                        <i class="fas fa-times-circle mr-2"></i>Cancel All Orders
                    </button>
                    <button onclick="broadcastMessage()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg transition-colors">
                        <i class="fas fa-bullhorn mr-2"></i>Broadcast Message
                    </button>
                    <button onclick="exportData()" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg transition-colors">
                        <i class="fas fa-download mr-2"></i>Export Data
                    </button>
                    <button onclick="showTournamentResetModal()" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-3 rounded-lg transition-colors">
                        <i class="fas fa-trophy mr-2"></i>Reset Tournament
                    </button>
                    <button id="tournament-control-btn" onclick="toggleTournament()" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg transition-colors">
                        <i class="fas fa-play mr-2"></i>Start Tournament
                    </button>
                </div>
            </div>
        </div>

        <!-- Live Tournament Dashboard -->
        <div class="mt-6 bg-white rounded-lg shadow" id="live-tournament-dashboard">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <h2 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-trophy text-red-600 mr-2"></i>Live Tournament Dashboard
                    </h2>
                    <span id="tournament-status" class="px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700">
                        <i class="fas fa-circle text-gray-500 mr-1"></i>Stopped
                    </span>
                    <span id="tournament-timer" class="px-3 py-1 text-sm rounded-full bg-blue-100 text-blue-700 font-mono hidden">
                        <i class="fas fa-clock mr-1"></i><span id="timer-display">00:00:00</span>
                    </span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-500">Auto-refresh: <span id="refresh-countdown">5</span>s</span>
                    <button onclick="toggleLiveUpdates()" id="live-updates-btn" class="text-sm px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700">
                        <i class="fas fa-pause mr-1"></i>Pause
                    </button>
                </div>
            </div>
            <div class="p-4">
                <!-- Tournament Stats -->
                <div class="grid grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600">Active Teams</div>
                        <div class="text-2xl font-bold text-blue-600" id="stat-active-teams">0</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600">Total Trades</div>
                        <div class="text-2xl font-bold text-green-600" id="stat-total-trades">0</div>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600">Total Volume</div>
                        <div class="text-2xl font-bold text-purple-600" id="stat-total-volume">$0</div>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-600">Avg ROI</div>
                        <div class="text-2xl font-bold text-orange-600" id="stat-avg-roi">0%</div>
                    </div>
                </div>

                <!-- Live Leaderboard -->
                <div class="space-y-3" id="live-leaderboard">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-trophy text-4xl mb-2"></i>
                        <p>Start tournament to see live rankings</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Book -->
        <div class="mt-6 bg-white rounded-lg shadow">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-list text-red-600 mr-2"></i>All Active Orders
                </h2>
                <button onclick="refreshAllOrders()" class="text-sm text-red-600 hover:text-red-700">
                    <i class="fas fa-sync-alt mr-1"></i>Refresh
                </button>
            </div>
            <div id="all-orders-list" class="p-4 max-h-96 overflow-y-auto">
                <div class="text-center text-gray-500 py-8">
                    <i class="fas fa-file-invoice text-4xl mb-2"></i>
                    <p>Loading orders...</p>
                </div>
            </div>
        </div>
        </div>
        <!-- End Overview Tab -->

        <!-- Team Management Tab Content -->
        <div id="content-teams" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow">
                <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                    <h2 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-users-cog text-red-600 mr-2"></i>Manage Teams
                    </h2>
                    <button onclick="refreshTeams()" class="text-sm text-red-600 hover:text-red-700">
                        <i class="fas fa-sync-alt mr-1"></i>Refresh
                    </button>
                </div>
                <div id="teams-management-list" class="p-4">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-users text-4xl mb-2"></i>
                        <p>Loading teams...</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Team Management Tab -->
    </div>

    <!-- Create Order Modal -->
    <div id="create-order-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-xl font-semibold text-gray-900">Create Admin Order</h3>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Team</label>
                    <select id="admin-order-team" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <option value="">Select team...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Side</label>
                    <select id="admin-order-side" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <option value="BUY">BUY</option>
                        <option value="SELL">SELL</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Product</label>
                    <select id="admin-order-product" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <option value="FOSFO">FOSFO</option>
                        <option value="GUACA">GUACA</option>
                        <option value="SEBO">SEBO</option>
                        <option value="PALTA-OIL">PALTA-OIL</option>
                        <option value="PITA">PITA</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Quantity</label>
                    <input type="number" id="admin-order-qty" class="w-full px-3 py-2 border border-gray-300 rounded-lg" min="1" value="10">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mode</label>
                    <select id="admin-order-mode" class="w-full px-3 py-2 border border-gray-300 rounded-lg" onchange="togglePriceField()">
                        <option value="MARKET">MARKET</option>
                        <option value="LIMIT">LIMIT</option>
                    </select>
                </div>
                <div id="price-field" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Limit Price</label>
                    <input type="number" id="admin-order-price" class="w-full px-3 py-2 border border-gray-300 rounded-lg" step="0.01" value="10.00">
                </div>
            </div>
            <div class="p-6 border-t border-gray-200 flex justify-end space-x-3">
                <button onclick="closeCreateOrderModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                    Cancel
                </button>
                <button onclick="submitAdminOrder()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
                    Create Order
                </button>
            </div>
        </div>
    </div>

    <!-- Team Edit Modal -->
    <div id="team-edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 my-8">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-xl font-semibold text-gray-900">
                    <i class="fas fa-edit text-red-600 mr-2"></i>Edit Team: <span id="edit-team-name" class="text-red-600"></span>
                </h3>
            </div>
            <div class="p-6 space-y-6 max-h-96 overflow-y-auto">
                <!-- Team Members Section -->
                <div class="border border-gray-200 rounded-lg p-4 bg-gradient-to-r from-blue-50 to-purple-50">
                    <h4 class="font-semibold text-gray-900 mb-3">
                        <i class="fas fa-users text-blue-600 mr-2"></i>Team Members
                    </h4>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Student Names (with emojis! ðŸ˜Š)
                            </label>
                            <input type="text" id="edit-members" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg" 
                                   placeholder="e.g., ðŸ‘¨â€ðŸ’» Juan, ðŸ‘©â€ðŸ’» MarÃ­a, ðŸ§‘â€ðŸ’» Carlos"
                                   value="">
                            <p class="text-xs text-gray-500 mt-1">
                                ðŸ’¡ Tip: Use emojis to make it fun! Separated by commas.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Balance Section -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <h4 class="font-semibold text-gray-900 mb-3">
                        <i class="fas fa-dollar-sign text-green-600 mr-2"></i>Balance
                    </h4>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Current Balance</label>
                            <input type="number" id="edit-balance" class="w-full px-3 py-2 border border-gray-300 rounded-lg" step="0.01" value="0">
                        </div>
                        <button onclick="resetBalance()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-undo mr-2"></i>Reset to Initial Balance
                        </button>
                    </div>
                </div>

                <!-- Inventory Section -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <h4 class="font-semibold text-gray-900 mb-3">
                        <i class="fas fa-boxes text-blue-600 mr-2"></i>Inventory
                    </h4>
                    <div id="edit-inventory" class="space-y-2">
                        <!-- Will be populated dynamically -->
                    </div>
                    <button onclick="resetInventory()" class="w-full mt-3 bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-undo mr-2"></i>Reset to Initial Inventory
                    </button>
                </div>

                <!-- Production Section -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <h4 class="font-semibold text-gray-900 mb-3">
                        <i class="fas fa-industry text-purple-600 mr-2"></i>Production Capacity
                    </h4>
                    <div id="edit-production" class="space-y-2">
                        <!-- Will be populated dynamically -->
                    </div>
                    <button onclick="resetProduction()" class="w-full mt-3 bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-undo mr-2"></i>Reset to Default Production
                    </button>
                </div>
            </div>
            <div class="p-6 border-t border-gray-200 flex justify-end space-x-3">
                <button onclick="closeTeamEditModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                    Cancel
                </button>
                <button onclick="saveTeamChanges()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
                    <i class="fas fa-save mr-2"></i>Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Tournament Reset Modal -->
    <div id="tournament-reset-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full mx-4 my-8">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-xl font-semibold text-gray-900">
                    <i class="fas fa-trophy text-purple-600 mr-2"></i>Reset Tournament Configuration
                </h3>
                <p class="text-sm text-gray-600 mt-2">Configure initial state for all teams in the tournament</p>
            </div>
            <div class="p-6 space-y-6 max-h-96 overflow-y-auto">
                <!-- Global Settings -->
                <div class="border border-purple-200 rounded-lg p-4 bg-purple-50">
                    <h4 class="font-semibold text-gray-900 mb-3">
                        <i class="fas fa-globe text-purple-600 mr-2"></i>Global Settings
                    </h4>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Initial Balance (all teams)</label>
                        <input type="number" id="tournament-balance" class="w-full px-3 py-2 border border-gray-300 rounded-lg" step="0.01" value="1000.00">
                    </div>
                </div>

                <!-- Team Inventory Assignments -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <h4 class="font-semibold text-gray-900 mb-3">
                        <i class="fas fa-boxes text-blue-600 mr-2"></i>Team Inventory Assignments
                    </h4>
                    <p class="text-xs text-gray-600 mb-3">Set initial inventory for each team. Leave at 0 for products you don't want to assign.</p>
                    <div id="tournament-team-assignments" class="space-y-4">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>

                <!-- Warning -->
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <div class="flex items-start">
                        <i class="fas fa-exclamation-triangle text-yellow-600 mr-2 mt-1"></i>
                        <div class="text-sm text-yellow-800">
                            <strong>Warning:</strong> This will reset ALL teams' balances and inventories. All active orders will be cancelled. This action cannot be undone.
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t border-gray-200 flex justify-end space-x-3">
                <button onclick="closeTournamentResetModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                    Cancel
                </button>
                <button onclick="confirmTournamentReset()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors">
                    <i class="fas fa-trophy mr-2"></i>Reset Tournament
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <script>
        // WebSocket connection
        let socket = null;
        let isConnected = false;
        let teams = [];

        // Auto-connect on load
        window.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('adminToken');
            if (!token) {
                window.location.href = '/';
                return;
            }
            connect(token);
            startAutoRefresh();
        });

        function connect(token) {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            socket = new WebSocket(wsUrl);
            
            socket.onopen = () => {
                isConnected = true;
                updateConnectionStatus(true);
                login(token);
            };
            
            socket.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    handleMessage(message);
                } catch (e) {
                    console.error('Failed to parse message:', e);
                }
            };
            
            socket.onclose = () => {
                isConnected = false;
                updateConnectionStatus(false);
                setTimeout(() => connect(token), 5000);
            };
        }

        function login(token) {
            sendMessage({
                type: "LOGIN",
                token: token
            });
        }

        function handleMessage(message) {
            switch (message.type) {
                case 'LOGIN_OK':
                    if (message.team !== 'admin') {
                        showToast('Access denied: Admin only', 'error');
                        logout();
                        return;
                    }
                    showToast('Admin authenticated', 'success');
                    refreshAll();
                    break;
                    
                case 'CONNECTED_SESSIONS':
                    displayUsers(message.sessions);
                    document.getElementById('stat-users').textContent = message.sessions.length;
                    break;
                    
                case 'ALL_ORDERS':
                    displayAllOrders(message.orders);
                    document.getElementById('stat-orders').textContent = message.orders.length;
                    break;
                    
                case 'PERFORMANCE_REPORT':
                    displayPerformance(message);
                    break;
                    
                case 'GLOBAL_PERFORMANCE_REPORT':
                    displayGlobalPerformance(message);
                    break;
                    
                case 'TICKER':
                    updateMarketData(message);
                    break;
                    
                case 'ADMIN_ACTION_RESPONSE':
                    handleAdminActionResponse(message);
                    break;
                    
                case 'BROADCAST_NOTIFICATION':
                    showToast(`ðŸ“¢ Admin: ${message.message}`, 'info');
                    break;
                    
                case 'EXPORT_DATA_RESPONSE':
                    handleExportDataResponse(message);
                    break;
                    
                case 'AVAILABLE_TEAMS':
                    handleAvailableTeams(message);
                    break;
                    
                case 'TEAM_ACTIVITY':
                    handleTeamActivity(message);
                    break;
                    
                case 'ALL_TEAMS':
                    displayTeamsList(message.teams);
                    allTeamsData = message.teams || [];
                    updateTeamSelector();
                    break;
                    
                case 'TEAM_UPDATED':
                    showToast('Team updated successfully', 'success');
                    refreshTeams();
                    break;
                    
                case 'TOURNAMENT_RESET_COMPLETE':
                    showToast(`ðŸ† Tournament reset complete! ${message.teamsReset} teams configured`, 'success', 5000);
                    refreshTeams();
                    refreshAll();
                    break;
                    
                case 'ORDER_ACK':
                    // Real-time order acknowledgment
                    showToast(`Order ${message.status}: ${message.clOrdID}`, 'info');
                    refreshAllOrders();
                    break;
                    
                case 'FILL':
                    // Real-time fill notification
                    showToast(`Fill: ${message.fillQty} ${message.product} @ $${message.fillPrice}`, 'success');
                    refreshAllOrders();
                    refreshPerformance();
                    break;
                    
                case 'ORDER_BOOK_UPDATE':
                    // Real-time order book update
                    updateMarketOverview(message);
                    break;
                    
                case 'ERROR':
                    showToast(`Error: ${message.reason}`, 'error');
                    break;
            }
        }

        function handleAvailableTeams(message) {
            teams = message.teams.map(t => t.teamName);
            
            // Update stats
            document.getElementById('stat-users').textContent = message.count;
        }

        function handleTeamActivity(message) {
            console.log('Team activity:', message);
            // Could display in a modal or panel
        }

        function updateMarketOverview(message) {
            // Update market overview with order book changes
            if (message.product) {
                console.log('Order book update:', message.product);
                // Refresh market data
            }
        }

        function handleAdminActionResponse(message) {
            if (message.success) {
                showToast(message.message, 'success');
                if (message.action === 'CANCEL_ALL_ORDERS') {
                    refreshAllOrders();
                }
            } else {
                showToast(`Action failed: ${message.message}`, 'error');
            }
        }

        function handleExportDataResponse(message) {
            const dataStr = JSON.stringify(message.data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `export-${message.dataType}-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast(`Exported ${message.count} ${message.dataType}`, 'success');
        }

        function displayUsers(sessions) {
            const container = document.getElementById('users-list');
            if (!sessions || sessions.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8"><p>No users connected</p></div>';
                return;
            }

            const teamMap = {};
            sessions.forEach(session => {
                if (!teamMap[session.teamName]) {
                    teamMap[session.teamName] = [];
                }
                teamMap[session.teamName].push(session);
            });

            teams = Object.keys(teamMap);
            updateTeamSelector();

            container.innerHTML = Object.entries(teamMap).map(([teamName, sessions]) => `
                <div class="border border-gray-200 rounded-lg p-4 mb-3">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-gray-900">${teamName}</h3>
                        <span class="text-sm text-gray-500">${sessions.length} session(s)</span>
                    </div>
                    ${sessions.map(s => `
                        <div class="text-sm text-gray-600 ml-4">
                            <span class="status-dot status-connected"></span>
                            ${s.clientType || 'Unknown'} - ${s.remoteAddr}
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }

         function displayAllOrders(orders) {
             const container = document.getElementById('all-orders-list');
             if (!orders || orders.length === 0) {
                 container.innerHTML = '<div class="text-center text-gray-500 py-8"><p>No active orders</p></div>';
                 return;
             }

             container.innerHTML = `
                 <table class="w-full">
                     <thead class="bg-gray-50">
                         <tr>
                             <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Team</th>
                             <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Side</th>
                             <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Product</th>
                             <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Qty</th>
                             <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Price</th>
                             <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Mode</th>
                             <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Message</th>
                         </tr>
                     </thead>
                     <tbody class="divide-y divide-gray-200">
                         ${orders.map(order => `
                             <tr class="hover:bg-gray-50">
                                 <td class="px-4 py-3 text-sm">${order.teamName}</td>
                                 <td class="px-4 py-3 text-sm">
                                     <span class="px-2 py-1 rounded text-xs font-medium ${
                                         order.side === 'BUY' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                     }">${order.side}</span>
                                 </td>
                                 <td class="px-4 py-3 text-sm font-mono">${order.product}</td>
                                 <td class="px-4 py-3 text-sm">${order.quantity}</td>
                                 <td class="px-4 py-3 text-sm">${order.price ? '$' + order.price.toFixed(2) : 'MARKET'}</td>
                                 <td class="px-4 py-3 text-sm">${order.mode}</td>
                                 <td class="px-4 py-3 text-sm text-gray-600 italic">${order.message || '-'}</td>
                             </tr>
                         `).join('')}
                     </tbody>
                 </table>
             `;
         }

        function updateTeamSelector() {
            const select = document.getElementById('admin-order-team');
            if (!select) return;
            
            const teamNames = allTeamsData.length > 0 
                ? allTeamsData.map(t => t.teamName).filter(name => name !== 'admin')
                : teams.filter(name => name !== 'admin');
            
            select.innerHTML = '<option value="">Select team...</option>' + 
                teamNames.map(team => `<option value="${team}">${team}</option>`).join('');
        }

        function updateConnectionStatus(connected) {
            const statusDot = document.querySelector('.status-dot');
            const statusText = document.getElementById('status-text');
            
            if (connected) {
                statusDot.classList.remove('status-disconnected');
                statusDot.classList.add('status-connected');
                statusText.textContent = 'Connected';
            } else {
                statusDot.classList.remove('status-connected');
                statusDot.classList.add('status-disconnected');
                statusText.textContent = 'Disconnected';
            }
        }

        function sendMessage(message) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify(message));
            }
        }

        function refreshSessions() {
            sendMessage({ type: "REQUEST_CONNECTED_SESSIONS" });
        }

        function refreshAllOrders() {
            sendMessage({ type: "REQUEST_ALL_ORDERS" });
        }

        function refreshPerformance() {
            sendMessage({ 
                type: "REQUEST_PERFORMANCE_REPORT",
                scope: "global"
            });
        }

        function refreshMarket() {
            showToast('Market refresh requested', 'info');
        }

        function refreshAll() {
            refreshSessions();
            refreshAllOrders();
            refreshPerformance();
            refreshAvailableTeams();
        }

        function refreshAvailableTeams() {
            sendMessage({ type: "GET_AVAILABLE_TEAMS" });
        }

        function getTeamActivity(teamName) {
            sendMessage({ 
                type: "GET_TEAM_ACTIVITY",
                teamName: teamName
            });
        }

        function startAutoRefresh() {
            setInterval(refreshAll, 5000);
        }

        function showCreateOrderModal() {
            if (allTeamsData.length === 0) {
                sendMessage({ type: "GET_ALL_TEAMS" });
            }
            updateTeamSelector();
            document.getElementById('create-order-modal').classList.remove('hidden');
        }

        function closeCreateOrderModal() {
            document.getElementById('create-order-modal').classList.add('hidden');
        }

        function togglePriceField() {
            const mode = document.getElementById('admin-order-mode').value;
            const priceField = document.getElementById('price-field');
            
            if (mode === 'LIMIT') {
                priceField.classList.remove('hidden');
            } else {
                priceField.classList.add('hidden');
            }
        }

        function submitAdminOrder() {
            const team = document.getElementById('admin-order-team').value;
            const side = document.getElementById('admin-order-side').value;
            const product = document.getElementById('admin-order-product').value;
            const qty = parseInt(document.getElementById('admin-order-qty').value);
            const mode = document.getElementById('admin-order-mode').value;
            const price = parseFloat(document.getElementById('admin-order-price').value);

            if (!team) {
                showToast('Please select a team', 'warning');
                return;
            }

            const order = {
                type: "ADMIN_CREATE_ORDER",
                teamName: team,
                side: side,
                mode: mode,
                product: product,
                qty: qty,
                message: "Created via admin dashboard"
            };

            if (mode === 'LIMIT') {
                order.limitPrice = price;
            }

            sendMessage(order);
            closeCreateOrderModal();
            showToast(`Creating order for ${team}...`, 'info');
        }

        function logout() {
            localStorage.removeItem('adminToken');
            if (socket) {
                socket.close();
            }
            window.location.href = '/';
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            const toast = document.createElement('div');
            toast.className = `${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300`;
            toast.textContent = message;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function displayPerformance(data) {
            const container = document.getElementById('performance-list');
            
            if (!data || !data.teamName) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8"><p>No performance data</p></div>';
                return;
            }

            const pnl = data.profitLoss || 0;
            const pnlClass = pnl >= 0 ? 'text-green-600' : 'text-red-600';
            const roi = data.roi || 0;
            
            container.innerHTML = `
                <div class="border border-gray-200 rounded-lg p-4 mb-3">
                    <div class="flex justify-between items-center mb-3">
                        <div>
                            <h3 class="font-semibold text-gray-900">${data.teamName}</h3>
                            <p class="text-sm text-gray-500">${data.totalTrades || 0} trades</p>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold ${pnlClass}">${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}</p>
                            <p class="text-sm text-gray-500">P&L (${roi.toFixed(1)}% ROI)</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div>
                            <span class="text-gray-600">Start:</span>
                            <span class="font-medium ml-1">$${data.startBalance?.toFixed(2) || '0.00'}</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Final:</span>
                            <span class="font-medium ml-1">$${data.finalBalance?.toFixed(2) || '0.00'}</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Buy Trades:</span>
                            <span class="font-medium ml-1">${data.buyTrades || 0}</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Sell Trades:</span>
                            <span class="font-medium ml-1">${data.sellTrades || 0}</span>
                        </div>
                    </div>
                </div>
            `;
            showToast('Performance data updated', 'info');
        }

        function displayGlobalPerformance(data) {
            const container = document.getElementById('performance-list');
            
            if (!data || !data.topTraders || data.topTraders.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8"><p>No performance data available</p></div>';
                return;
            }

            document.getElementById('stat-trades').textContent = data.totalTrades || 0;

            container.innerHTML = data.topTraders.map((team, index) => {
                const pnl = team.profitLoss || 0;
                const pnlClass = pnl >= 0 ? 'text-green-600' : 'text-red-600';
                const roi = team.roi || 0;
                const rankBadge = index < 3 ? ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰'][index] : `#${index + 1}`;
                
                return `
                    <div class="border border-gray-200 rounded-lg p-4 mb-3">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center space-x-3">
                                <span class="text-2xl">${rankBadge}</span>
                                <div>
                                    <h3 class="font-semibold text-gray-900">${team.teamName}</h3>
                                    <p class="text-sm text-gray-500">${team.totalTrades || 0} trades Â· ${roi.toFixed(1)}% ROI</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-lg font-bold ${pnlClass}">${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}</p>
                                <p class="text-xs text-gray-500">Balance: $${team.finalBalance?.toFixed(2) || '0.00'}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            showToast(`Performance data loaded: ${data.topTraders.length} teams`, 'success');
        }

        function updateMarketData(ticker) {
            const container = document.getElementById('market-overview');
            
            // Create or update ticker card
            let tickerCard = container.querySelector(`[data-product="${ticker.product}"]`);
            
            if (!tickerCard) {
                // Remove loading message
                const loading = container.querySelector('.text-center');
                if (loading) {
                    container.innerHTML = '';
                }
                
                tickerCard = document.createElement('div');
                tickerCard.className = 'border border-gray-200 rounded-lg p-4 mb-3';
                tickerCard.setAttribute('data-product', ticker.product);
                container.appendChild(tickerCard);
            }
            
            const bidText = ticker.bestBid ? `$${ticker.bestBid.toFixed(2)}` : 'N/A';
            const askText = ticker.bestAsk ? `$${ticker.bestAsk.toFixed(2)}` : 'N/A';
            const midText = ticker.mid ? `$${ticker.mid.toFixed(2)}` : 'N/A';
            const spreadText = (ticker.bestBid && ticker.bestAsk) ? 
                `$${(ticker.bestAsk - ticker.bestBid).toFixed(2)}` : 'N/A';
            
            tickerCard.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-lg font-semibold text-gray-900">${ticker.product}</h3>
                    <span class="text-xs text-gray-500">${new Date(ticker.serverTime).toLocaleTimeString()}</span>
                </div>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <div>
                        <span class="text-gray-600">Bid:</span>
                        <span class="font-medium text-green-600 ml-1">${bidText}</span>
                    </div>
                    <div>
                        <span class="text-gray-600">Ask:</span>
                        <span class="font-medium text-red-600 ml-1">${askText}</span>
                    </div>
                    <div>
                        <span class="text-gray-600">Mid:</span>
                        <span class="font-medium text-blue-600 ml-1">${midText}</span>
                    </div>
                    <div>
                        <span class="text-gray-600">Spread:</span>
                        <span class="font-medium text-gray-900 ml-1">${spreadText}</span>
                    </div>
                </div>
                <div class="mt-2 text-xs text-gray-500">
                    24h Volume: ${ticker.volume24h || 0}
                </div>
            `;
        }

        function cancelAllOrders() {
            if (!confirm('Are you sure you want to cancel ALL orders in the system?')) {
                return;
            }
            
            sendMessage({
                type: "ADMIN_CANCEL_ALL_ORDERS"
            });
            showToast('Cancelling all orders...', 'info');
        }

        function broadcastMessage() {
            const message = prompt('Enter message to broadcast to all users:');
            if (!message) {
                return;
            }
            
            sendMessage({
                type: "ADMIN_BROADCAST",
                message: message
            });
            showToast('Broadcasting message...', 'info');
        }

        function exportData() {
            sendMessage({
                type: "EXPORT_DATA",
                dataType: "orders"
            });
            showToast('Exporting data...', 'info');
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('border-red-600', 'text-red-600');
                tab.classList.add('border-transparent', 'text-gray-500');
            });
            
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('border-red-600', 'text-red-600');
            document.getElementById(`tab-${tabName}`).classList.remove('border-transparent', 'text-gray-500');
            
            if (tabName === 'teams') {
                refreshTeams();
            }
        }

        // Team management
        let currentEditingTeam = null;
        let allTeamsData = [];

        function refreshTeams() {
            sendMessage({ type: "GET_ALL_TEAMS" });
        }

        function displayTeamsList(teams) {
            allTeamsData = teams;
            const container = document.getElementById('teams-management-list');
            
            if (!teams || teams.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8"><p>No teams found</p></div>';
                return;
            }

            container.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Team</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Species</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Balance</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Inventory</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Connected</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${teams.map(team => {
                                const connected = team.connected ? 'ðŸŸ¢ Yes' : 'ðŸ”´ No';
                                const inventoryTotal = Object.values(team.inventory || {}).reduce((a, b) => a + b, 0);
                                
                                return `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-4 py-3">
                                            <div class="font-medium text-gray-900">${team.teamName}</div>
                                        </td>
                                        <td class="px-4 py-3 text-sm text-gray-600">${team.species || 'N/A'}</td>
                                        <td class="px-4 py-3 text-sm font-mono">$${team.currentBalance?.toFixed(2) || '0.00'}</td>
                                        <td class="px-4 py-3 text-sm text-gray-600">${inventoryTotal} items</td>
                                        <td class="px-4 py-3 text-sm">${connected}</td>
                                        <td class="px-4 py-3 text-center">
                                            <button onclick="openTeamEditModal('${team.teamName}')" 
                                                    class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition-colors">
                                                <i class="fas fa-edit mr-1"></i>Edit
                                            </button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function openTeamEditModal(teamName) {
            currentEditingTeam = allTeamsData.find(t => t.teamName === teamName);
            if (!currentEditingTeam) {
                showToast('Team not found', 'error');
                return;
            }

            document.getElementById('edit-team-name').textContent = teamName;
            document.getElementById('edit-members').value = currentEditingTeam.members || '';
            document.getElementById('edit-balance').value = currentEditingTeam.currentBalance || 0;

            // Populate inventory
            const inventoryContainer = document.getElementById('edit-inventory');
            const products = ['FOSFO', 'GUACA', 'SEBO', 'PALTA-OIL', 'PITA', 'H-GUACA'];
            inventoryContainer.innerHTML = products.map(product => {
                const qty = currentEditingTeam.inventory?.[product] || 0;
                return `
                    <div class="flex items-center justify-between">
                        <label class="text-sm font-medium text-gray-700">${product}:</label>
                        <input type="number" id="inv-${product}" value="${qty}" min="0" 
                               class="w-24 px-2 py-1 border border-gray-300 rounded text-sm">
                    </div>
                `;
            }).join('');

            // Populate production (placeholder - will use recipes if available)
            const productionContainer = document.getElementById('edit-production');
            productionContainer.innerHTML = products.map(product => {
                return `
                    <div class="flex items-center justify-between">
                        <label class="text-sm font-medium text-gray-700">${product} capacity:</label>
                        <input type="number" id="prod-${product}" value="10" min="0" 
                               class="w-24 px-2 py-1 border border-gray-300 rounded text-sm">
                    </div>
                `;
            }).join('');

            document.getElementById('team-edit-modal').classList.remove('hidden');
        }

        function closeTeamEditModal() {
            document.getElementById('team-edit-modal').classList.add('hidden');
            currentEditingTeam = null;
        }

        function saveTeamChanges() {
            if (!currentEditingTeam) return;

            const balance = parseFloat(document.getElementById('edit-balance').value);
            const members = document.getElementById('edit-members').value.trim();
            const inventory = {};
            const products = ['FOSFO', 'GUACA', 'SEBO', 'PALTA-OIL', 'PITA', 'H-GUACA'];
            
            products.forEach(product => {
                const input = document.getElementById(`inv-${product}`);
                if (input) {
                    inventory[product] = parseInt(input.value) || 0;
                }
            });

            // Update team members separately
            if (members !== (currentEditingTeam.members || '')) {
                sendMessage({
                    type: "UPDATE_TEAM_MEMBERS",
                    teamName: currentEditingTeam.teamName,
                    members: members
                });
            }

            sendMessage({
                type: "UPDATE_TEAM",
                teamName: currentEditingTeam.teamName,
                balance: balance,
                inventory: inventory
            });

            showToast('Saving team changes...', 'info');
            closeTeamEditModal();
        }

        function resetBalance() {
            if (!currentEditingTeam) return;
            
            if (!confirm(`Reset ${currentEditingTeam.teamName}'s balance to initial value?`)) {
                return;
            }

            sendMessage({
                type: "RESET_TEAM_BALANCE",
                teamName: currentEditingTeam.teamName
            });

            showToast('Resetting balance...', 'info');
            closeTeamEditModal();
        }

        function resetInventory() {
            if (!currentEditingTeam) return;
            
            if (!confirm(`Reset ${currentEditingTeam.teamName}'s inventory to initial values?`)) {
                return;
            }

            sendMessage({
                type: "RESET_TEAM_INVENTORY",
                teamName: currentEditingTeam.teamName
            });

            showToast('Resetting inventory...', 'info');
            closeTeamEditModal();
        }

        function resetProduction() {
            if (!currentEditingTeam) return;
            
            if (!confirm(`Reset ${currentEditingTeam.teamName}'s production capacity?`)) {
                return;
            }

            sendMessage({
                type: "RESET_TEAM_PRODUCTION",
                teamName: currentEditingTeam.teamName
            });

            showToast('Resetting production...', 'info');
        }

        // Tournament Reset
        function showTournamentResetModal() {
            const modal = document.getElementById('tournament-reset-modal');
            
            // Load teams and populate assignments
            if (allTeamsData.length === 0) {
                showToast('Please load teams first (go to Team Management tab)', 'warning');
                return;
            }

            const container = document.getElementById('tournament-team-assignments');
            const products = ['FOSFO', 'GUACA', 'SEBO', 'PALTA-OIL', 'PITA', 'H-GUACA'];
            
            container.innerHTML = allTeamsData.map((team, index) => {
                return `
                    <div class="border border-gray-200 rounded-lg p-3 bg-gray-50">
                        <div class="font-semibold text-gray-900 mb-2">${team.teamName}</div>
                        <div class="grid grid-cols-2 gap-2">
                            ${products.map(product => {
                                const defaultQty = (products[index % products.length] === product) ? 10 : 0;
                                return `
                                    <div class="flex items-center justify-between text-sm">
                                        <label class="text-gray-700">${product}:</label>
                                        <input type="number" 
                                               id="team-inv-${team.teamName}-${product}" 
                                               value="${defaultQty}" 
                                               min="0" 
                                               class="w-20 px-2 py-1 border border-gray-300 rounded text-right">
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            modal.classList.remove('hidden');
        }

        function closeTournamentResetModal() {
            document.getElementById('tournament-reset-modal').classList.add('hidden');
        }

        function confirmTournamentReset() {
            if (!confirm('âš ï¸ This will reset ALL teams!\n\nAll balances will be reset.\nAll inventories will be cleared.\nAll active orders will be cancelled.\n\nAre you absolutely sure?')) {
                return;
            }

            const balance = parseFloat(document.getElementById('tournament-balance').value);
            
            if (isNaN(balance) || balance < 0) {
                showToast('Invalid balance', 'error');
                return;
            }

            const products = ['FOSFO', 'GUACA', 'SEBO', 'PALTA-OIL', 'PITA', 'H-GUACA'];
            const teamConfigs = [];
            
            allTeamsData.forEach(team => {
                const inventory = {};
                products.forEach(product => {
                    const input = document.getElementById(`team-inv-${team.teamName}-${product}`);
                    if (input) {
                        const qty = parseInt(input.value) || 0;
                        inventory[product] = qty;
                    }
                });
                
                teamConfigs.push({
                    teamName: team.teamName,
                    inventory: inventory
                });
            });

            sendMessage({
                type: "RESET_TOURNAMENT_CONFIG",
                balance: balance,
                teamConfigs: teamConfigs
            });

            showToast('Resetting tournament configuration...', 'info');
            closeTournamentResetModal();
        }

        // Debug Mode Functions
        async function loadDebugModeStatus() {
            try {
                const response = await fetch('/admin/api/debug-mode');
                const data = await response.json();
                updateDebugModeUI(data.enabled);
            } catch (error) {
                console.error('Failed to load debug mode status:', error);
                showToast('Failed to load debug mode status', 'error');
            }
        }

        function updateDebugModeUI(enabled) {
            const statusEl = document.getElementById('debug-mode-status');
            const toggleBtn = document.getElementById('toggle-debug-btn');
            
            if (enabled) {
                statusEl.innerHTML = '<span class="text-yellow-600"><i class="fas fa-flask mr-2"></i>DEBUG MODE</span>';
                toggleBtn.className = 'px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-all shadow-sm hover:shadow-md';
                toggleBtn.innerHTML = '<i class="fas fa-lock mr-2"></i>Disable Debug Mode';
            } else {
                statusEl.innerHTML = '<span class="text-green-600"><i class="fas fa-shield-alt mr-2"></i>REAL MODE</span>';
                toggleBtn.className = 'px-6 py-3 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg font-medium transition-all shadow-sm hover:shadow-md';
                toggleBtn.innerHTML = '<i class="fas fa-flask mr-2"></i>Enable Debug Mode';
            }
        }

        async function toggleDebugMode() {
            try {
                const response = await fetch('/admin/api/debug-mode');
                const current = await response.json();
                const newState = !current.enabled;
                
                // Confirmation dialog
                const action = newState ? 'ENABLE' : 'DISABLE';
                const warning = newState 
                    ? 'âš ï¸ WARNING: This will allow debug features like AUTO_ACCEPT orders.\n\nOnly enable this in development/staging environments.\n\nContinue?' 
                    : 'âœ… This will disable all debug features and switch to production mode.\n\nAll AUTO_ACCEPT orders will be rejected.\n\nContinue?';
                
                if (!confirm(warning)) {
                    return;
                }

                // Prompt for admin name/email
                const updatedBy = prompt('Enter your name or email for audit trail:');
                if (!updatedBy || updatedBy.trim() === '') {
                    showToast('Admin name/email is required', 'warning');
                    return;
                }

                // Update debug mode
                const updateResponse = await fetch('/admin/api/debug-mode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        enabled: newState,
                        updatedBy: updatedBy.trim()
                    })
                });

                const result = await updateResponse.json();
                
                if (result.success) {
                    updateDebugModeUI(result.debugMode);
                    document.getElementById('debug-last-changed').textContent = new Date().toLocaleString();
                    document.getElementById('debug-changed-by').textContent = updatedBy.trim();
                    showToast(result.message, 'success');
                    
                    // Log to console
                    console.log(`ðŸ”§ Debug Mode ${action}D by ${updatedBy.trim()} at ${new Date().toISOString()}`);
                } else {
                    showToast('Failed to toggle debug mode', 'error');
                }
            } catch (error) {
                console.error('Failed to toggle debug mode:', error);
                showToast('Failed to toggle debug mode: ' + error.message, 'error');
            }
        }

        // Load debug mode status on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadDebugModeStatus();
        });

        // ===== LIVE TOURNAMENT DASHBOARD =====
        let tournamentActive = false;
        let liveUpdatesEnabled = true;
        let liveUpdateInterval = null;
        let refreshCountdown = 5;
        let teamPerformanceData = {};
        let tournamentStartTime = null;
        let tournamentTimerInterval = null;

        async function toggleTournament() {
            tournamentActive = !tournamentActive;
            const btn = document.getElementById('tournament-control-btn');
            const status = document.getElementById('tournament-status');
            const timer = document.getElementById('tournament-timer');
            
            if (tournamentActive) {
                // Start tournament - disable debug mode
                await toggleDebugModeForTournament(false);
                
                btn.innerHTML = '<i class="fas fa-stop mr-2"></i>Stop Tournament';
                btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                btn.classList.add('bg-red-600', 'hover:bg-red-700');
                status.innerHTML = '<i class="fas fa-circle text-green-500 mr-1 animate-pulse"></i>Active';
                status.classList.remove('bg-gray-200', 'text-gray-700');
                status.classList.add('bg-green-100', 'text-green-700');
                
                // Show and start timer
                timer.classList.remove('hidden');
                startTournamentTimer();
                
                startLiveUpdates();
                showToast('Tournament started! Debug mode OFF, Timer started', 'success');
            } else {
                // Stop tournament - enable debug mode
                await toggleDebugModeForTournament(true);
                
                btn.innerHTML = '<i class="fas fa-play mr-2"></i>Start Tournament';
                btn.classList.remove('bg-red-600', 'hover:bg-red-700');
                btn.classList.add('bg-green-600', 'hover:bg-green-700');
                status.innerHTML = '<i class="fas fa-circle text-gray-500 mr-1"></i>Stopped';
                status.classList.remove('bg-green-100', 'text-green-700');
                status.classList.add('bg-gray-200', 'text-gray-700');
                
                // Stop timer
                stopTournamentTimer();
                
                stopLiveUpdates();
                showToast('Tournament stopped! Debug mode ON', 'info');
            }
        }

        async function toggleDebugModeForTournament(enable) {
            try {
                const response = await fetch('/admin/api/debug-mode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: enable })
                });
                
                if (response.ok) {
                    console.log(`Debug mode ${enable ? 'enabled' : 'disabled'} for tournament`);
                } else {
                    console.error('Failed to toggle debug mode');
                }
            } catch (error) {
                console.error('Error toggling debug mode:', error);
            }
        }

        function startTournamentTimer() {
            tournamentStartTime = Date.now();
            if (tournamentTimerInterval) clearInterval(tournamentTimerInterval);
            
            tournamentTimerInterval = setInterval(() => {
                const elapsed = Date.now() - tournamentStartTime;
                const hours = Math.floor(elapsed / 3600000);
                const minutes = Math.floor((elapsed % 3600000) / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                
                document.getElementById('timer-display').textContent = 
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 1000);
        }

        function stopTournamentTimer() {
            if (tournamentTimerInterval) {
                clearInterval(tournamentTimerInterval);
                tournamentTimerInterval = null;
            }
            document.getElementById('tournament-timer').classList.add('hidden');
            document.getElementById('timer-display').textContent = '00:00:00';
        }

        function toggleLiveUpdates() {
            liveUpdatesEnabled = !liveUpdatesEnabled;
            const btn = document.getElementById('live-updates-btn');
            
            if (liveUpdatesEnabled) {
                btn.innerHTML = '<i class="fas fa-pause mr-1"></i>Pause';
                btn.classList.remove('bg-gray-600');
                btn.classList.add('bg-red-600');
                if (tournamentActive) startLiveUpdates();
                showToast('Live updates resumed', 'info');
            } else {
                btn.innerHTML = '<i class="fas fa-play mr-1"></i>Resume';
                btn.classList.remove('bg-red-600');
                btn.classList.add('bg-gray-600');
                stopLiveUpdates();
                showToast('Live updates paused', 'info');
            }
        }

        function startLiveUpdates() {
            if (!liveUpdatesEnabled || !tournamentActive) return;
            
            // Initial update
            updateLiveDashboard();
            
            // Clear any existing interval
            if (liveUpdateInterval) clearInterval(liveUpdateInterval);
            
            // Update every second for countdown, every 5 seconds for data
            refreshCountdown = 5;
            liveUpdateInterval = setInterval(() => {
                refreshCountdown--;
                document.getElementById('refresh-countdown').textContent = refreshCountdown;
                
                if (refreshCountdown <= 0) {
                    updateLiveDashboard();
                    refreshCountdown = 5;
                }
            }, 1000);
        }

        function stopLiveUpdates() {
            if (liveUpdateInterval) {
                clearInterval(liveUpdateInterval);
                liveUpdateInterval = null;
            }
        }

        function updateLiveDashboard() {
            // Request fresh performance data
            sendMessage({ 
                type: "REQUEST_PERFORMANCE_REPORT",
                scope: "global"
            });
            
            // Request all teams data
            sendMessage({ type: "GET_ALL_TEAMS" });
        }

        function updateLiveLeaderboard(teams) {
            if (!teams || teams.length === 0) return;
            
            // Calculate performance metrics for each team
            const teamMetrics = teams.map(team => {
                const currentValue = team.currentBalance + calculateInventoryValue(team.inventory);
                const roi = team.initialBalance > 0 ? 
                    ((currentValue - team.initialBalance) / team.initialBalance) * 100 : 0;
                
                // Store for animations
                const oldROI = teamPerformanceData[team.teamName]?.roi || roi;
                const roiChange = roi - oldROI;
                
                teamPerformanceData[team.teamName] = {
                    roi: roi,
                    balance: currentValue,
                    trades: teamPerformanceData[team.teamName]?.trades || 0
                };
                
                return {
                    teamName: team.teamName,
                    species: team.species,
                    members: team.members || '',
                    balance: currentValue,
                    initialBalance: team.initialBalance,
                    roi: roi,
                    roiChange: roiChange,
                    inventory: team.inventory || {},
                    trades: teamPerformanceData[team.teamName]?.trades || 0
                };
            });
            
            // Sort by ROI descending
            teamMetrics.sort((a, b) => b.roi - a.roi);
            
            // Update stats
            document.getElementById('stat-active-teams').textContent = teams.length;
            const avgROI = teamMetrics.reduce((sum, t) => sum + t.roi, 0) / teamMetrics.length;
            document.getElementById('stat-avg-roi').textContent = avgROI.toFixed(2) + '%';
            
            // Render leaderboard
            const leaderboard = document.getElementById('live-leaderboard');
            leaderboard.innerHTML = teamMetrics.map((team, index) => {
                const rankClass = index === 0 ? 'bg-yellow-50 border-yellow-300' : 
                                 index === 1 ? 'bg-gray-50 border-gray-300' :
                                 index === 2 ? 'bg-orange-50 border-orange-300' : 
                                 'bg-white border-gray-200';
                
                const roiClass = team.roi > 0 ? 'text-green-600' : 
                                team.roi < 0 ? 'text-red-600' : 'text-gray-600';
                
                const roiIcon = team.roiChange > 0 ? '<i class="fas fa-arrow-up text-green-500"></i>' :
                               team.roiChange < 0 ? '<i class="fas fa-arrow-down text-red-500"></i>' :
                               '<i class="fas fa-minus text-gray-500"></i>';
                
                const medal = index === 0 ? '<i class="fas fa-trophy text-yellow-500 text-xl"></i>' :
                             index === 1 ? '<i class="fas fa-medal text-gray-400 text-xl"></i>' :
                             index === 2 ? '<i class="fas fa-award text-orange-500 text-xl"></i>' :
                             `<span class="text-lg font-bold text-gray-400">#${index + 1}</span>`;
                
                // Format inventory display
                const inventoryItems = Object.entries(team.inventory)
                    .filter(([_, qty]) => qty > 0)
                    .map(([product, qty]) => `
                        <span class="inline-block px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs mr-1">
                            ${product}: ${qty}
                        </span>
                    `).join('');
                
                return `
                    <div class="border-2 ${rankClass} rounded-lg p-4 transition-all duration-500 hover:shadow-lg">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center space-x-3">
                                <div class="flex-shrink-0">${medal}</div>
                                <div>
                                    <div class="font-semibold text-lg">${team.teamName}</div>
                                    <div class="text-sm text-gray-500">${team.species}</div>
                                    ${team.members ? `<div class="text-xs text-blue-600 mt-1">${team.members}</div>` : ''}
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold ${roiClass}">
                                    ${team.roi >= 0 ? '+' : ''}${team.roi.toFixed(2)}%
                                    ${roiIcon}
                                </div>
                                <div class="text-sm text-gray-500">$${team.balance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-2 text-sm border-t pt-3">
                            <div>
                                <div class="text-gray-500">Trades</div>
                                <div class="font-semibold">${team.trades}</div>
                            </div>
                            <div>
                                <div class="text-gray-500">Initial</div>
                                <div class="font-semibold">$${team.initialBalance.toLocaleString()}</div>
                            </div>
                            <div>
                                <div class="text-gray-500">P&L</div>
                                <div class="font-semibold ${team.roi >= 0 ? 'text-green-600' : 'text-red-600'}">
                                    ${team.roi >= 0 ? '+' : ''}$${(team.balance - team.initialBalance).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                </div>
                            </div>
                        </div>
                        ${inventoryItems ? `
                        <div class="mt-3 border-t pt-3">
                            <div class="text-xs text-gray-500 mb-2">Inventory:</div>
                            <div class="flex flex-wrap gap-1">
                                ${inventoryItems}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function calculateInventoryValue(inventory) {
            if (!inventory) return 0;
            // Simple estimation: use $10 per unit (can be improved with real market prices)
            return Object.values(inventory).reduce((sum, qty) => sum + (qty * 10), 0);
        }

        // Update performance data when PERFORMANCE_REPORT or team data arrives
        function handlePerformanceUpdate(message) {
            if (message.type === 'PERFORMANCE_REPORT') {
                if (message.teamName && teamPerformanceData[message.teamName]) {
                    teamPerformanceData[message.teamName].trades = message.totalTrades || 0;
                }
                
                // Update total trades stat
                const totalTrades = Object.values(teamPerformanceData)
                    .reduce((sum, data) => sum + (data.trades || 0), 0);
                document.getElementById('stat-total-trades').textContent = totalTrades;
            }
        }

        // Update the message handler to process team data for live dashboard
        const originalHandleMessage = handleMessage;
        function handleMessage(message) {
            // Call original handler
            if (typeof originalHandleMessage === 'function') {
                originalHandleMessage(message);
            }
            
            // Process for live dashboard
            if (tournamentActive && liveUpdatesEnabled) {
                if (message.type === 'ALL_TEAMS_RESPONSE' && message.teams) {
                    updateLiveLeaderboard(message.teams);
                }
                
                if (message.type === 'PERFORMANCE_REPORT') {
                    handlePerformanceUpdate(message);
                }
                
                if (message.type === 'FILL') {
                    // Increment trade count
                    const buyerTeam = message.buyer || message.teamName;
                    if (teamPerformanceData[buyerTeam]) {
                        teamPerformanceData[buyerTeam].trades = (teamPerformanceData[buyerTeam].trades || 0) + 1;
                    }
                    // Trigger dashboard update
                    setTimeout(() => updateLiveDashboard(), 500);
                }
            }
        }
    </script>
</body>
</html>
