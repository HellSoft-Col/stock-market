<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intergalactic Avocado Stock Exchange</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            display: grid;
            grid-template-columns: 350px 1fr 350px;
            grid-template-rows: 80px 1fr;
            height: 100vh;
            gap: 10px;
            padding: 10px;
        }
        
        .header {
            grid-column: 1 / -1;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            color: white;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }
        
        .panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            color: white;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            overflow-y: auto;
        }
        
        .login-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .market-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .ticker-board {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            min-height: 200px;
        }
        
        .order-book {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            flex: 1;
        }
        
        .trading-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .order-form {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
        }
        
        .messages {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .status {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .status.disconnected {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid #e74c3c;
        }
        
        .status.connected {
            background: rgba(46, 204, 113, 0.2);
            border: 1px solid #2ecc71;
        }
        
        .status.authenticated {
            background: rgba(52, 152, 219, 0.2);
            border: 1px solid #3498db;
        }
        
        input, select, button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        button {
            background: rgba(52, 152, 219, 0.3);
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        button:hover {
            background: rgba(52, 152, 219, 0.5);
        }
        
        button:disabled {
            background: rgba(127, 140, 141, 0.3);
            cursor: not-allowed;
        }
        
        .ticker-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .ticker-item:last-child {
            border-bottom: none;
        }
        
        .product {
            font-weight: bold;
            font-size: 16px;
        }
        
        .price {
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .bid { color: #2ecc71; }
        .ask { color: #e74c3c; }
        .mid { color: #f39c12; }
        
        .message {
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 4px;
            word-wrap: break-word;
        }
        
        .message.info { background: rgba(52, 152, 219, 0.2); }
        .message.success { background: rgba(46, 204, 113, 0.2); }
        .message.error { background: rgba(231, 76, 60, 0.2); }
        .message.fill { background: rgba(155, 89, 182, 0.2); }
        
        h2, h3 {
            margin-bottom: 15px;
            font-weight: 300;
        }
        
        .form-row {
            display: flex;
            gap: 10px;
        }
        
        .form-row input,
        .form-row select {
            margin-bottom: 10px;
        }
        
        .order-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            border-left: 4px solid;
        }
        
        .order-item.buy { border-left-color: #2ecc71; }
        .order-item.sell { border-left-color: #e74c3c; }
        .order-item.pending { border-left-color: #f39c12; }
        .order-item.filled { border-left-color: #9b59b6; }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .order-details {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .order-actions {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }
        
        .order-actions button {
            flex: 1;
            margin-bottom: 0;
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .approve-btn {
            background: rgba(46, 204, 113, 0.3) !important;
        }
        
        .approve-btn:hover {
            background: rgba(46, 204, 113, 0.5) !important;
        }
        
        .deny-btn {
            background: rgba(231, 76, 60, 0.3) !important;
        }
        
        .deny-btn:hover {
            background: rgba(231, 76, 60, 0.5) !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ¥‘ Intergalactic Avocado Stock Exchange</h1>
            <div>
                <span id="connection-time"></span>
                <span id="server-time"></span>
            </div>
        </div>
        
        <div class="panel login-panel">
            <h2>Authentication</h2>
            <div id="status" class="status disconnected">Disconnected</div>
            
            <input type="text" id="token" placeholder="Enter your team token (TK-...)" />
            <button id="connect-btn" onclick="connect()">Connect</button>
            <button id="login-btn" onclick="login()" disabled>Login</button>
            
            <div id="team-info" style="display: none;">
                <h3>Team Information</h3>
                <div id="team-details"></div>
            </div>
        </div>
        
        <div class="panel market-panel">
            <h2>Market Data</h2>
            
            <div class="ticker-board">
                <h3>Live Ticker</h3>
                <div id="ticker-list"></div>
            </div>
            
            <div class="order-book">
                <h3>Order Book</h3>
                <div id="order-book-data">
                    <p>Select a product to view order book</p>
                </div>
            </div>
            
            <div class="order-management" style="background: rgba(0, 0, 0, 0.2); border-radius: 10px; padding: 15px; margin-top: 10px;">
                <h3>Live Orders</h3>
                <div id="live-orders-list" style="max-height: 200px; overflow-y: auto;">
                    <p>No active orders</p>
                </div>
            </div>
        </div>
        
        <div class="panel trading-panel">
            <h2>Trading</h2>
            
            <div class="order-form">
                <h3>Place Order</h3>
                <select id="side">
                    <option value="BUY">Buy</option>
                    <option value="SELL">Sell</option>
                </select>
                
                <select id="mode">
                    <option value="MARKET">Market Order</option>
                    <option value="LIMIT">Limit Order</option>
                </select>
                
                <select id="product">
                    <option value="FOSFO">FOSFO</option>
                    <option value="PITA">PITA</option>
                    <option value="PALTA-OIL">PALTA-OIL</option>
                    <option value="GUACA">GUACA</option>
                    <option value="SEBO">SEBO</option>
                    <option value="H-GUACA">H-GUACA</option>
                </select>
                
                <div class="form-row">
                    <input type="number" id="qty" placeholder="Quantity" min="1" />
                    <input type="number" id="price" placeholder="Price (for limit orders)" step="0.01" />
                </div>
                
                <input type="text" id="message" placeholder="Optional message" />
                <button id="place-order-btn" onclick="placeOrder()" disabled>Place Order</button>
            </div>
            
            <div class="messages">
                <h3>Messages</h3>
                <div id="message-list"></div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let connected = false;
        let authenticated = false;
        let teamInfo = null;
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 5;
        let reconnectDelay = 1000;
        let pingInterval = null;
        let orders = new Map();
        
        const statusEl = document.getElementById('status');
        const connectBtn = document.getElementById('connect-btn');
        const loginBtn = document.getElementById('login-btn');
        const placeOrderBtn = document.getElementById('place-order-btn');
        const messageList = document.getElementById('message-list');
        const tickerList = document.getElementById('ticker-list');
        const connectionTime = document.getElementById('connection-time');
        const serverTime = document.getElementById('server-time');
        
        function updateStatus(status, message) {
            statusEl.className = `status ${status}`;
            statusEl.textContent = message;
        }
        
        function addMessage(type, message) {
            const msg = document.createElement('div');
            msg.className = `message ${type}`;
            msg.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            messageList.appendChild(msg);
            messageList.scrollTop = messageList.scrollHeight;
        }
        
        function connect() {
            if (ws) {
                ws.close();
            }
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            updateStatus('connecting', 'Connecting...');
            addMessage('info', 'Connecting to WebSocket...');
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                connected = true;
                reconnectAttempts = 0;
                updateStatus('connected', 'Connected - Please login');
                addMessage('success', 'WebSocket connected');
                connectBtn.textContent = 'Disconnect';
                loginBtn.disabled = false;
                connectionTime.textContent = `Connected: ${new Date().toLocaleTimeString()}`;
                
                // Start ping/pong mechanism
                startPing();
            };
            
            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handleMessage(data);
                } catch (e) {
                    addMessage('error', `Failed to parse message: ${e.message}`);
                }
            };
            
            ws.onclose = function(event) {
                connected = false;
                authenticated = false;
                stopPing();
                
                if (event.wasClean) {
                    updateStatus('disconnected', 'Disconnected');
                    addMessage('info', 'WebSocket disconnected cleanly');
                } else {
                    updateStatus('disconnected', 'Connection lost');
                    addMessage('error', `WebSocket disconnected unexpectedly: ${event.code} ${event.reason}`);
                    
                    // Attempt reconnection
                    if (reconnectAttempts < maxReconnectAttempts) {
                        attemptReconnect();
                    } else {
                        addMessage('error', 'Max reconnection attempts reached');
                    }
                }
                
                connectBtn.textContent = 'Connect';
                loginBtn.disabled = true;
                placeOrderBtn.disabled = true;
                document.getElementById('team-info').style.display = 'none';
            };
            
            ws.onerror = function(error) {
                addMessage('error', `WebSocket error: ${error}`);
            };
        }
        
        function attemptReconnect() {
            reconnectAttempts++;
            const delay = reconnectDelay * Math.pow(2, reconnectAttempts - 1); // Exponential backoff
            
            updateStatus('connecting', `Reconnecting... (${reconnectAttempts}/${maxReconnectAttempts})`);
            addMessage('info', `Attempting reconnection ${reconnectAttempts}/${maxReconnectAttempts} in ${delay}ms`);
            
            setTimeout(() => {
                if (!connected) {
                    connect();
                }
            }, delay);
        }
        
        function startPing() {
            pingInterval = setInterval(() => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({type: 'PING'}));
                }
            }, 25000); // Ping every 25 seconds
        }
        
        function stopPing() {
            if (pingInterval) {
                clearInterval(pingInterval);
                pingInterval = null;
            }
        }
        
        function disconnect() {
            if (ws) {
                ws.close();
            }
        }
        
        function login() {
            const token = document.getElementById('token').value.trim();
            if (!token) {
                addMessage('error', 'Please enter a token');
                return;
            }
            
            const loginMsg = {
                type: 'LOGIN',
                token: token
            };
            
            addMessage('info', `Attempting login with token: ${token}`);
            ws.send(JSON.stringify(loginMsg));
        }
        
        function placeOrder() {
            if (!authenticated) {
                addMessage('error', 'Must be authenticated to place orders');
                return;
            }
            
            const side = document.getElementById('side').value;
            const mode = document.getElementById('mode').value;
            const product = document.getElementById('product').value;
            const qty = parseInt(document.getElementById('qty').value);
            const price = parseFloat(document.getElementById('price').value);
            const message = document.getElementById('message').value;
            
            if (!qty || qty <= 0) {
                addMessage('error', 'Please enter a valid quantity');
                return;
            }
            
            if (mode === 'LIMIT' && (!price || price <= 0)) {
                addMessage('error', 'Please enter a valid price for limit orders');
                return;
            }
            
            const clOrdID = `ORD-${teamInfo.team}-${Date.now()}-${Math.random().toString(36).substr(2, 8)}`;
            
            const orderMsg = {
                type: 'ORDER',
                clOrdID: clOrdID,
                side: side,
                mode: mode,
                product: product,
                qty: qty,
                message: message || undefined
            };
            
            if (mode === 'LIMIT') {
                orderMsg.price = price;
            }
            
            addMessage('info', `Placing ${side} order: ${qty} ${product} @ ${mode}`);
            ws.send(JSON.stringify(orderMsg));
            
            // Track the order locally
            addOrderToTracker(clOrdID, side, mode, product, qty, price, message);
            
            // Clear form
            document.getElementById('qty').value = '';
            document.getElementById('price').value = '';
            document.getElementById('message').value = '';
        }
        
        function handleMessage(data) {
            switch (data.type) {
                case 'LOGIN_OK':
                    authenticated = true;
                    teamInfo = data;
                    updateStatus('authenticated', `Authenticated as ${data.team}`);
                    addMessage('success', `Logged in as ${data.team} (${data.species})`);
                    placeOrderBtn.disabled = false;
                    
                    // Show team info with inventory
                    const teamInfoEl = document.getElementById('team-info');
                    const teamDetailsEl = document.getElementById('team-details');
                    
                    const inventoryHtml = data.inventory ? 
                        Object.entries(data.inventory)
                            .filter(([product, qty]) => qty > 0)
                            .map(([product, qty]) => `${product}: ${qty}`)
                            .join(', ') || 'No inventory' 
                        : 'No inventory';
                    
                    teamDetailsEl.innerHTML = `
                        <p><strong>Team:</strong> ${data.team}</p>
                        <p><strong>Species:</strong> ${data.species}</p>
                        <p><strong>Balance:</strong> $${data.currentBalance || data.initialBalance}</p>
                        <p><strong>Inventory:</strong> ${inventoryHtml}</p>
                        <p><strong>Authorized Products:</strong> ${data.authorizedProducts.join(', ')}</p>
                    `;
                    teamInfoEl.style.display = 'block';
                    break;
                    
                case 'ERROR':
                    addMessage('error', `${data.code}: ${data.reason}`);
                    // If order error, update order status
                    if (data.clOrdID) {
                        updateOrderStatus(data.clOrdID, 'error', data.reason);
                    }
                    break;
                    
                case 'ORDER_ACK':
                    addMessage('success', `Order acknowledged: ${data.clOrdID}`);
                    updateOrderStatus(data.clOrdID, 'pending', 'Order acknowledged by server');
                    break;
                    
                case 'FILL':
                    addMessage('fill', `FILL: ${data.fillQty} ${data.product} @ $${data.fillPrice} (${data.side}) - Counterparty: ${data.counterparty}`);
                    updateOrderStatus(data.clOrdID, 'filled', `Filled ${data.fillQty}/${data.totalQty} @ $${data.fillPrice}`);
                    break;
                    
                case 'TICKER':
                    updateTicker(data);
                    if (data.serverTime) {
                        serverTime.textContent = `Server: ${new Date(data.serverTime).toLocaleTimeString()}`;
                    }
                    break;
                    
                case 'OFFER':
                    addMessage('info', `OFFER: ${data.buyer} wants ${data.quantityRequested} ${data.product} @ max $${data.maxPrice} (expires in ${data.expiresIn}ms)`);
                    displayOfferForApproval(data);
                    break;
                    
                case 'INVENTORY_UPDATE':
                    updateInventoryDisplay(data.inventory);
                    addMessage('info', 'Inventory updated');
                    break;
                    
                case 'PONG':
                    // Server responded to ping
                    break;
                    
                case 'ECHO':
                    addMessage('info', `Echo: ${JSON.stringify(data.original)}`);
                    break;
                    
                default:
                    addMessage('info', `${data.type}: ${JSON.stringify(data)}`);
            }
        }
        
        function updateTicker(ticker) {
            let tickerItem = document.querySelector(`[data-product="${ticker.product}"]`);
            
            if (!tickerItem) {
                tickerItem = document.createElement('div');
                tickerItem.className = 'ticker-item';
                tickerItem.setAttribute('data-product', ticker.product);
                tickerList.appendChild(tickerItem);
            }
            
            tickerItem.innerHTML = `
                <div class="product">${ticker.product}</div>
                <div class="price">
                    <span class="bid">Bid: $${ticker.bestBid || 'N/A'}</span> |
                    <span class="ask">Ask: $${ticker.bestAsk || 'N/A'}</span> |
                    <span class="mid">Mid: $${ticker.mid || 'N/A'}</span>
                </div>
            `;
        }
        
        // Auto-connect on page load
        window.onload = function() {
            // Set up connect button click handler
            connectBtn.onclick = function() {
                if (connected) {
                    disconnect();
                } else {
                    connect();
                }
            };
        };
        
        // Handle Enter key in token input
        document.getElementById('token').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (!connected) {
                    connect();
                } else {
                    login();
                }
            }
        });
        
        // Handle Enter key in order form
        ['qty', 'price', 'message'].forEach(id => {
            document.getElementById(id).addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    placeOrder();
                }
            });
        });
        
        // Order tracking functions
        function addOrderToTracker(clOrdID, side, mode, product, qty, price, message) {
            const order = {
                clOrdID,
                side,
                mode,
                product,
                qty,
                price,
                message,
                status: 'submitted',
                timestamp: new Date(),
                statusText: 'Submitted to server'
            };
            
            orders.set(clOrdID, order);
            updateOrdersDisplay();
        }
        
        function updateOrderStatus(clOrdID, status, statusText) {
            const order = orders.get(clOrdID);
            if (order) {
                order.status = status;
                order.statusText = statusText;
                order.lastUpdate = new Date();
                updateOrdersDisplay();
            }
        }
        
        function updateOrdersDisplay() {
            const ordersContainer = document.getElementById('live-orders-list');
            
            if (orders.size === 0) {
                ordersContainer.innerHTML = '<p>No active orders</p>';
                return;
            }
            
            const orderArray = Array.from(orders.values()).sort((a, b) => b.timestamp - a.timestamp);
            
            ordersContainer.innerHTML = orderArray.map(order => {
                const priceText = order.mode === 'LIMIT' && order.price ? `@ $${order.price}` : '@ Market';
                const timeText = order.timestamp.toLocaleTimeString();
                
                return `
                    <div class="order-item ${order.side.toLowerCase()} ${order.status}">
                        <div class="order-header">
                            <strong>${order.side} ${order.qty} ${order.product}</strong>
                            <span class="timestamp">${timeText}</span>
                        </div>
                        <div class="order-details">
                            ${order.mode} ${priceText} | Status: ${order.statusText}
                            ${order.message ? `| Message: "${order.message}"` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function displayOfferForApproval(offer) {
            const ordersContainer = document.getElementById('live-orders-list');
            
            // Create offer element for approval/denial
            const offerElement = document.createElement('div');
            offerElement.className = 'order-item pending';
            offerElement.innerHTML = `
                <div class="order-header">
                    <strong>OFFER: ${offer.buyer} wants ${offer.quantityRequested} ${offer.product}</strong>
                    <span>@ max $${offer.maxPrice}</span>
                </div>
                <div class="order-details">
                    Offer ID: ${offer.offerId} | Expires in: ${offer.expiresIn}ms
                </div>
                <div class="order-actions" id="offer-actions-${offer.offerId}">
                    <button class="approve-btn" onclick="respondToOffer('${offer.offerId}', true)">Approve</button>
                    <button class="deny-btn" onclick="respondToOffer('${offer.offerId}', false)">Deny</button>
                </div>
            `;
            
            // Add to top of orders list
            ordersContainer.insertBefore(offerElement, ordersContainer.firstChild);
            
            // Auto-remove after expiration
            if (offer.expiresIn) {
                setTimeout(() => {
                    if (offerElement.parentNode) {
                        offerElement.remove();
                    }
                }, offer.expiresIn);
            }
        }
        
        function respondToOffer(offerId, accept) {
            if (!authenticated) {
                addMessage('error', 'Must be authenticated to respond to offers');
                return;
            }
            
            const response = {
                type: 'ACCEPT_OFFER',
                offerId: offerId,
                accept: accept
            };
            
            ws.send(JSON.stringify(response));
            
            // Remove offer actions
            const actionsEl = document.getElementById(`offer-actions-${offerId}`);
            if (actionsEl) {
                actionsEl.innerHTML = `<span style="color: ${accept ? '#2ecc71' : '#e74c3c'};">${accept ? 'APPROVED' : 'DENIED'}</span>`;
            }
            
            addMessage('info', `Offer ${offerId} ${accept ? 'approved' : 'denied'}`);
        }
        
        function updateInventoryDisplay(inventory) {
            if (!teamInfo) return;
            
            // Update the stored team info
            teamInfo.inventory = inventory;
            
            // Update the display
            const teamDetailsEl = document.getElementById('team-details');
            const inventoryHtml = inventory ? 
                Object.entries(inventory)
                    .filter(([product, qty]) => qty > 0)
                    .map(([product, qty]) => `${product}: ${qty}`)
                    .join(', ') || 'No inventory' 
                : 'No inventory';
            
            teamDetailsEl.innerHTML = `
                <p><strong>Team:</strong> ${teamInfo.team}</p>
                <p><strong>Species:</strong> ${teamInfo.species}</p>
                <p><strong>Balance:</strong> $${teamInfo.currentBalance || teamInfo.initialBalance}</p>
                <p><strong>Inventory:</strong> ${inventoryHtml}</p>
                <p><strong>Authorized Products:</strong> ${teamInfo.authorizedProducts.join(', ')}</p>
            `;
        }
        
        // Clean up old orders periodically
        setInterval(() => {
            const cutoff = new Date(Date.now() - 300000); // 5 minutes ago
            for (const [clOrdID, order] of orders.entries()) {
                if (order.status === 'filled' || order.status === 'error') {
                    if (order.timestamp < cutoff) {
                        orders.delete(clOrdID);
                    }
                }
            }
            updateOrdersDisplay();
        }, 60000); // Clean every minute
    </script>
</body>
</html>