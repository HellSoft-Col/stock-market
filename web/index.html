<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü•ë Intercambio de Aguacates - Consola de Depuraci√≥n</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            height: 100vh;
            overflow: hidden;
        }
        
        .debug-container {
            display: grid;
            grid-template-columns: 400px 1fr 400px;
            grid-template-rows: 70px 1fr;
            height: 100vh;
            gap: 12px;
            padding: 12px;
        }
        
        .header {
            grid-column: 1 / -1;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            color: white;
            box-shadow: 0 4px 16px rgba(31, 38, 135, 0.37);
        }
        
        .panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            color: white;
            box-shadow: 0 4px 16px rgba(31, 38, 135, 0.37);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            min-height: 0; /* Important for flexbox scrolling */
        }
        
        .center-panel {
            /* Ensure full width usage */
            width: 100%;
            min-width: 0; /* Important for grid items */
        }

        /* Ensure dashboard content uses full width */
        .center-panel .feature-section {
            width: 100%;
        }

        .center-panel .tab-content {
            width: 100%;
        }
        
        .status-bar {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 12px;
        }
        
        .status-indicator {
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 11px;
        }
        
        .status-disconnected { background: rgba(231, 76, 60, 0.3); border: 1px solid #e74c3c; }
        .status-connected { background: rgba(46, 204, 113, 0.3); border: 1px solid #2ecc71; }
        .status-authenticated { background: rgba(52, 152, 219, 0.3); border: 1px solid #3498db; }
        
        .tabs {
            display: flex;
            gap: 3px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 10px 14px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 8px 8px 0 0;
            color: white;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: background 0.3s, transform 0.2s;
            min-width: 70px;
            text-align: center;
        }
        
        .tab:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }
        
        .tab.active {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .tab-content {
            display: none !important;
            flex: 1;
            overflow-y: auto;
            min-height: 0; /* Important for flexbox scrolling */
        }
        
        .tab-content.active {
            display: flex !important;
            flex-direction: column;
        }
        
        input, select, button, textarea {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 12px;
            margin-bottom: 8px;
        }
        
        input::placeholder, textarea::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        button {
            background: rgba(52, 152, 219, 0.3);
            cursor: pointer;
            transition: background 0.3s;
            font-weight: bold;
        }
        
        button:hover:not(:disabled) {
            background: rgba(52, 152, 219, 0.5);
        }
        
        button:disabled {
            background: rgba(127, 140, 141, 0.3);
            cursor: not-allowed;
        }
        
        .btn-small {
            padding: 4px 8px;
            font-size: 10px;
            margin: 2px;
            width: auto;
        }
        
        .form-row {
            display: flex;
            gap: 8px;
        }
        
        .form-row input, .form-row select {
            margin-bottom: 8px;
        }
        
        .ticker-item, .order-item {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 6px;
            border-left: 3px solid;
            font-size: 11px;
        }
        
        .order-item.buy { border-left-color: #2ecc71; }
        .order-item.sell { border-left-color: #e74c3c; }
        .order-item.filled { border-left-color: #9b59b6; }
        .order-item.pending { border-left-color: #f39c12; }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
            font-weight: bold;
        }
        
        .order-details {
            font-size: 10px;
            opacity: 0.8;
        }
        
        .messages {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            padding: 8px;
            height: 150px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 10px;
        }
        
        .message {
            margin-bottom: 3px;
            padding: 3px;
            border-radius: 3px;
            word-wrap: break-word;
        }
        
        .message.info { background: rgba(52, 152, 219, 0.2); }
        .message.success { background: rgba(46, 204, 113, 0.2); }
        .message.error { background: rgba(231, 76, 60, 0.2); }
        .message.fill { background: rgba(155, 89, 182, 0.2); }
        
        .price-bid { color: #2ecc71; }
        .price-ask { color: #e74c3c; }
        .price-mid { color: #f39c12; }
        
        h2 {
            font-size: 16px;
            margin-bottom: 12px;
            font-weight: 400;
        }
        
        h3 {
            font-size: 14px;
            margin-bottom: 8px;
            font-weight: 400;
        }
        
        .team-info {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 8px;
            font-size: 11px;
        }
        
        .team-info p {
            margin: 2px 0;
        }
        
        .debug-section {
            margin-bottom: 12px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
        }
        
        .debug-section h4 {
            font-size: 12px;
            margin-bottom: 8px;
            color: #f39c12;
        }
        
        .order-book-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 8px;
        }
        
        .order-book-side {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            padding: 8px;
        }
        
        .order-book-side h5 {
            font-size: 11px;
            margin-bottom: 6px;
            text-align: center;
        }
        
        .order-book-side.buy h5 { color: #2ecc71; }
        .order-book-side.sell h5 { color: #e74c3c; }
        
        .order-book-entry {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            padding: 2px 4px;
            margin: 1px 0;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .debug-warning {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid #ffc107;
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 8px;
            font-size: 10px;
            color: #ffc107;
        }
        
        .session-item {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 6px;
            border-left: 3px solid;
            font-size: 11px;
        }
        
        .session-item.authenticated { border-left-color: #2ecc71; }
        .session-item.connected { border-left-color: #f39c12; }
        .session-item.web-client { border-left-color: #3498db; }
        .session-item.java-client { border-left-color: #e67e22; }
        
        .multiple-clients {
            background: linear-gradient(90deg, rgba(52, 152, 219, 0.1) 50%, rgba(230, 126, 34, 0.1) 50%);
        }

        .price-slider {
            width: 100%;
            margin: 8px 0;
        }

        .market-simulator {
            background: rgba(46, 204, 113, 0.1);
            border: 1px solid #2ecc71;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .error-injection {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid #e74c3c;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .production-validator {
            background: rgba(155, 89, 182, 0.1);
            border: 1px solid #9b59b6;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .offer-tester {
            background: rgba(241, 196, 15, 0.1);
            border: 1px solid #f1c40f;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .transaction-log {
            background: rgba(52, 152, 219, 0.1);
            border: 1px solid #3498db;
            border-radius: 8px;
            padding: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .feature-section {
            margin-bottom: 20px;
            padding: 16px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
        }

        .feature-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-group {
            display: flex;
            gap: 4px;
            margin: 8px 0;
            flex-wrap: wrap;
        }

        .btn-group button {
            flex: 1;
            min-width: 80px;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-top: 8px;
        }

        .inventory-item {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            padding: 8px;
            text-align: center;
            font-size: 11px;
        }

        .algorithm-result {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            padding: 8px;
            margin: 8px 0;
            font-family: 'Courier New', monospace;
            font-size: 10px;
        }

        .timer-display {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid #ffc107;
            border-radius: 4px;
            padding: 4px 8px;
            font-family: 'Courier New', monospace;
            font-size: 10px;
            margin: 4px 0;
        }

        /* Tooltip Styles */
        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip:hover::before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 1000;
            opacity: 0;
            animation: fadeIn 0.3s ease forwards;
        }

        .tooltip:hover::after {
            content: '';
            position: absolute;
            bottom: 115%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top: 5px solid rgba(0, 0, 0, 0.9);
            z-index: 1000;
            opacity: 0;
            animation: fadeIn 0.3s ease forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Disabled button styles with better feedback */
        button:disabled {
            background: rgba(127, 140, 141, 0.3) !important;
            cursor: not-allowed;
            position: relative;
        }

        button:disabled:hover::before {
            content: attr(data-disabled-reason);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(231, 76, 60, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 1000;
            animation: fadeIn 0.3s ease forwards;
        }

        /* Alert styles */
        .alert {
            position: fixed;
            top: 90px;
            right: 20px;
            background: rgba(52, 152, 219, 0.95);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1001;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            transform: translateX(400px);
            animation: slideIn 0.3s ease forwards;
        }

        .alert.success {
            background: rgba(46, 204, 113, 0.95);
        }

        .alert.error {
            background: rgba(231, 76, 60, 0.95);
        }

        .alert.warning {
            background: rgba(241, 196, 15, 0.95);
            color: #333;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); }
            to { transform: translateX(0); }
        }

        @keyframes slideOut {
            from { transform: translateX(0); }
            to { transform: translateX(400px); }
        }

        /* Connection status indicator enhancements */
        .status-indicator {
            position: relative;
        }

        .status-indicator::after {
            content: '';
            position: absolute;
            right: -10px;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-connected::after {
            background: #2ecc71;
        }

        .status-connecting::after {
            background: #f39c12;
        }

        .status-disconnected::after {
            background: #e74c3c;
        }

        .status-authenticated::after {
            background: #3498db;
        }

        @keyframes pulse {
            0% { opacity: 1; transform: translateY(-50%) scale(1); }
            50% { opacity: 0.6; transform: translateY(-50%) scale(1.2); }
            100% { opacity: 1; transform: translateY(-50%) scale(1); }
        }

        /* Responsive design improvements */
        @media (max-width: 1400px) {
            .debug-container {
                grid-template-columns: 350px 1fr 350px;
            }
        }

        @media (max-width: 1200px) {
            .debug-container {
                grid-template-columns: 300px 1fr 300px;
            }
        }

        @media (max-width: 1000px) {
            .debug-container {
                grid-template-columns: 1fr;
                grid-template-rows: 70px auto auto auto;
            }
            
            .panel {
                max-height: 500px;
            }
        }

        /* Improve form layouts */
        .form-row {
            display: flex;
            gap: 12px;
            align-items: stretch;
        }
        
        .form-row input, .form-row select {
            flex: 1;
            margin-bottom: 12px;
        }

        /* Enhanced input and button focus states */
        input:focus, select:focus, textarea:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.5);
        }

        button:hover:not(:disabled) {
            background: rgba(52, 152, 219, 0.6);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <div class="header">
            <div>
                <h1>ü•ë Intercambio de Aguacates - Consola de Depuraci√≥n</h1>
                <p style="font-size: 12px; opacity: 0.8; margin: 0;">
                    üõ†Ô∏è Interfaz de Depuraci√≥n - Los clientes Java deben conectarse como clientes de trading normales
                </p>
            </div>
            <div class="status-bar">
                <div id="status-indicator" class="status-indicator status-disconnected">Desconectado</div>
                <span id="connection-time"></span>
                <span id="server-time"></span>
            </div>
        </div>
        
        <!-- Left Panel: Authentication & Market Simulator -->
        <div class="panel">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('auth')">üîê Auth</button>
                <button class="tab" onclick="switchTab('simulator')">üéØ Simulador</button>
                <button class="tab" onclick="switchTab('debug')">üß™ Debug</button>
                <button class="tab" onclick="switchTab('sessions')">üë• Sesiones</button>
                <button class="tab" onclick="switchTab('docs')">üìö Docs</button>
            </div>
            
            <div id="auth-tab" class="tab-content active">
                <div class="debug-warning">
                    <strong>üö® CONSOLA DE DEPURACI√ìN</strong><br>
                    ¬°Esta es una herramienta de depuraci√≥n, no un cliente de trading! 
                    Tus clientes Java deben conectarse independientemente y comportarse como clientes de trading reales.
                </div>
                
                <h3>üîê Autenticaci√≥n</h3>
                <input type="text" id="token" placeholder="Token del equipo (TK-...)" />
                <button id="connect-btn" onclick="toggleConnection()">Conectar</button>
                <button id="login-btn" onclick="login()" disabled data-disabled-reason="Primero debe conectarse al servidor">Iniciar Sesi√≥n</button>
                
                <div id="team-info" class="team-info" style="display: none;">
                    <div id="team-details"></div>
                </div>

                <!-- Inventory Visualizer -->
                <div class="feature-section">
                    <div class="feature-title">
                        <span>üì¶</span>
                        <span>Visualizador de Inventario</span>
                    </div>
                    <div id="inventory-visualizer" class="inventory-grid">
                        <div class="inventory-item">No hay datos</div>
                    </div>
                </div>
            </div>

            <!-- Market Simulator Tab -->
            <div id="simulator-tab" class="tab-content">
                <div class="feature-section market-simulator">
                    <div class="feature-title">
                        <span>üéØ</span>
                        <span>Simulador de Mercado</span>
                    </div>
                    
                    <h4>üìà Creaci√≥n Manual de √ìrdenes</h4>
                    <select id="sim-side">
                        <option value="BUY">üü¢ Comprar</option>
                        <option value="SELL">üî¥ Vender</option>
                    </select>
                    <select id="sim-product">
                        <option value="FOSFO">FOSFO</option>
                        <option value="PITA">PITA</option>
                        <option value="PALTA-OIL">PALTA-OIL</option>
                        <option value="GUACA">GUACA</option>
                        <option value="SEBO">SEBO</option>
                        <option value="H-GUACA">H-GUACA</option>
                    </select>
                    <input type="number" id="sim-qty" placeholder="Cantidad" min="1" />
                    <input type="number" id="sim-price" placeholder="Precio" step="0.01" />
                    <button onclick="createMarketOrder()" disabled id="create-order-btn" data-disabled-reason="Debe autenticarse para crear √≥rdenes de mercado">Crear Orden de Mercado</button>

                    <h4>üéöÔ∏è Control de Precios</h4>
                    <div id="price-controls">
                        <div>
                            <label>FOSFO: $<span id="fosfo-price">10.00</span></label>
                            <input type="range" class="price-slider" id="fosfo-slider" min="5" max="50" value="10" step="0.1" onchange="updatePrice('FOSFO', this.value)">
                        </div>
                        <div>
                            <label>PITA: $<span id="pita-price">15.00</span></label>
                            <input type="range" class="price-slider" id="pita-slider" min="10" max="60" value="15" step="0.1" onchange="updatePrice('PITA', this.value)">
                        </div>
                        <div>
                            <label>PALTA-OIL: $<span id="palta-oil-price">25.00</span></label>
                            <input type="range" class="price-slider" id="palta-oil-slider" min="20" max="80" value="25" step="0.1" onchange="updatePrice('PALTA-OIL', this.value)">
                        </div>
                    </div>

                    <h4>ü§ñ Auto-Market Maker</h4>
                    <div class="btn-group">
                        <button onclick="toggleAutoMarketMaker()" id="auto-mm-btn">üü¢ Activar Auto-MM</button>
                        <button onclick="clearAllOrders()" id="clear-orders-btn">üóëÔ∏è Limpiar √ìrdenes</button>
                    </div>
                </div>
            </div>
            
            <div id="debug-tab" class="tab-content">
                <!-- Error Injection Panel -->
                <div class="feature-section error-injection">
                    <div class="feature-title">
                        <span>‚ö†Ô∏è</span>
                        <span>Panel de Inyecci√≥n de Errores</span>
                    </div>
                    <div class="btn-group">
                        <button onclick="injectError('INSUFFICIENT_BALANCE')" disabled id="err-balance-btn" data-disabled-reason="Debe autenticarse para inyectar errores de prueba">‚ùå Saldo Insuficiente</button>
                        <button onclick="injectError('UNAUTHORIZED_PRODUCT')" disabled id="err-product-btn" data-disabled-reason="Debe autenticarse para inyectar errores de prueba">‚ùå Producto No Autorizado</button>
                    </div>
                    <div class="btn-group">
                        <button onclick="injectError('DISCONNECT_CLIENT')" disabled id="err-disconnect-btn" data-disabled-reason="Debe autenticarse para inyectar errores de prueba">üîå Desconectar Cliente</button>
                        <button onclick="injectError('OFFER_EXPIRED')" disabled id="err-expire-btn" data-disabled-reason="Debe autenticarse para inyectar errores de prueba">‚è∞ Expirar Oferta</button>
                    </div>
                </div>

                <!-- Production Validator -->
                <div class="feature-section production-validator">
                    <div class="feature-title">
                        <span>üè≠</span>
                        <span>Validador de Producci√≥n</span>
                    </div>
                    <select id="prod-product">
                        <option value="FOSFO">FOSFO</option>
                        <option value="PITA">PITA</option>
                        <option value="PALTA-OIL">PALTA-OIL</option>
                        <option value="GUACA">GUACA</option>
                        <option value="SEBO">SEBO</option>
                        <option value="H-GUACA">H-GUACA</option>
                    </select>
                    <input type="number" id="prod-qty" placeholder="Cantidad" min="1" />
                    <button onclick="testProduction()" disabled id="prod-btn" data-disabled-reason="Debe autenticarse para simular producci√≥n">üß™ Simular Producci√≥n</button>
                    
                    <div id="production-result" class="algorithm-result" style="display: none;">
                        <div><strong>Producci√≥n Recibida:</strong> <span id="prod-received"></span></div>
                        <div><strong>Esperado (algoritmo):</strong></div>
                        <div id="prod-algorithm"></div>
                        <div><strong>Resultado:</strong> <span id="prod-validation"></span></div>
                        <div><strong>Bonus Premium:</strong> <span id="prod-premium"></span></div>
                    </div>
                </div>

                <!-- Offer Tester -->
                <div class="feature-section offer-tester">
                    <div class="feature-title">
                        <span>üéØ</span>
                        <span>Probador de Ofertas</span>
                    </div>
                    <select id="offer-product">
                        <option value="FOSFO">FOSFO</option>
                        <option value="PITA">PITA</option>
                        <option value="PALTA-OIL">PALTA-OIL</option>
                        <option value="GUACA">GUACA</option>
                        <option value="SEBO">SEBO</option>
                        <option value="H-GUACA">H-GUACA</option>
                    </select>
                    <input type="number" id="offer-qty" placeholder="Cantidad" min="1" />
                    <input type="number" id="offer-max-price" placeholder="Precio M√°ximo" step="0.01" />
                    <textarea id="offer-message" placeholder="¬°Urgente! Necesario para producci√≥n premium" rows="2"></textarea>
                    <button onclick="sendTestOffer()" disabled id="send-offer-btn" data-disabled-reason="Debe autenticarse para enviar ofertas de prueba">üì§ Enviar Oferta</button>
                    
                    <div id="offer-response" style="display: none;">
                        <div class="timer-display">‚è±Ô∏è Tiempo de respuesta: <span id="response-timer">--</span></div>
                        <div><strong>Estado:</strong> <span id="offer-status">Pendiente...</span></div>
                    </div>
                </div>
                
                <div class="debug-section">
                    <h4>üìä Datos de Mercado</h4>
                    <button onclick="requestAllOrders()" disabled id="all-orders-btn" data-disabled-reason="Debe autenticarse para obtener datos del mercado">Obtener Todas las √ìrdenes</button>
                    <button onclick="requestOrderBook()" disabled id="order-book-btn" data-disabled-reason="Debe autenticarse para obtener datos del mercado">Actualizar Libro de √ìrdenes</button>
                </div>
                
                <div class="debug-section">
                    <h4>üîÑ Prueba de Conexi√≥n</h4>
                    <button onclick="sendPing()" disabled id="ping-btn" data-disabled-reason="Debe estar conectado para enviar ping">Enviar Ping</button>
                    <button onclick="requestResync()" disabled id="resync-btn" data-disabled-reason="Debe autenticarse para solicitar resincronizaci√≥n">Solicitar Resincronizaci√≥n</button>
                </div>
            </div>
            
            <div id="sessions-tab" class="tab-content">
                <div class="debug-warning">
                    <strong>üìã Monitor de Sesiones</strong><br>
                    Muestra equipos conectados con el mismo token. Si ves "M√∫ltiples Clientes" significa que tanto 
                    tu consola de depuraci√≥n como el cliente Java est√°n conectados con el mismo token. ‚úÖ
                </div>
                
                <div class="debug-section">
                    <h4>üë• Sesiones Conectadas</h4>
                    <p style="font-size: 10px; opacity: 0.7; margin-bottom: 8px;">
                        Monitorea conexiones activas de clientes (se actualiza autom√°ticamente cada 10s)
                    </p>
                    <button onclick="requestConnectedSessions()" disabled id="sessions-btn" data-disabled-reason="Debe autenticarse para ver sesiones conectadas">Actualizar Sesiones</button>
                    <div id="sessions-list" style="margin-top: 8px;">
                        <p>No hay datos de sesi√≥n disponibles</p>
                    </div>
                </div>
                
                <div class="debug-section">
                    <h4>üìà Estad√≠sticas del Servidor</h4>
                    <div id="server-stats">
                        <div class="team-info">
                            <p id="total-connections">Conexiones Totales: -</p>
                            <p id="total-orders">√ìrdenes Totales: -</p>
                            <p id="total-fills">Ejecuciones Totales: -</p>
                            <p id="server-uptime">Tiempo de Actividad del Servidor: -</p>
                    </div>
                </div>
            </div>
            
            <div id="docs-tab" class="tab-content">
                <div style="max-height: 100%; overflow-y: auto; padding-right: 8px;">
                    <h3>üìö Documentaci√≥n / Documentation</h3>
                    
                    <div class="debug-section">
                        <h4>üéØ Prop√≥sito de esta Consola</h4>
                        <p style="font-size: 11px; line-height: 1.4; margin-bottom: 8px;">
                            Esta es una <strong>consola de depuraci√≥n</strong>, NO un cliente de trading. 
                            Tu cliente Java debe conectarse independientemente como un cliente normal.
                        </p>
                        <p style="font-size: 11px; line-height: 1.4; color: #f39c12;">
                            <strong>Importante:</strong> Usa el mismo token en tu cliente Java y en esta consola 
                            para monitorear las conexiones y depurar problemas.
                        </p>
                    </div>
                    
                    <div class="debug-section">
                        <h4>üîê Autenticaci√≥n</h4>
                        <p style="font-size: 11px; line-height: 1.4; margin-bottom: 4px;">
                            ‚Ä¢ <strong>Token:</strong> Usa tu token TK-XXXX proporcionado por el profesor<br>
                            ‚Ä¢ <strong>Conectar:</strong> Establece conexi√≥n WebSocket con el servidor<br>
                            ‚Ä¢ <strong>Login:</strong> Autentica usando tu token de equipo
                        </p>
                    </div>
                    
                    <div class="debug-section">
                        <h4>üë• Sesiones Conectadas</h4>
                        <p style="font-size: 11px; line-height: 1.4; margin-bottom: 4px;">
                            ‚Ä¢ <strong>üåê Web Browser:</strong> Esta consola de depuraci√≥n<br>
                            ‚Ä¢ <strong>‚òï Java Client:</strong> Tu cliente de trading Java<br>
                            ‚Ä¢ <strong>Estado:</strong> Connected (conectado) vs Authenticated (autenticado)<br>
                            ‚Ä¢ <strong>Mismo Equipo:</strong> M√∫ltiples conexiones del mismo token aparecer√°n aqu√≠
                        </p>
                    </div>
                    
                    <div class="debug-section">
                        <h4>üìä Datos de Mercado</h4>
                        <p style="font-size: 11px; line-height: 1.4; margin-bottom: 4px;">
                            ‚Ä¢ <strong>Ticker:</strong> Precios en tiempo real (Bid/Ask/Mid)<br>
                            ‚Ä¢ <strong>Order Book:</strong> √ìrdenes de compra y venta por producto<br>
                            ‚Ä¢ <strong>All Orders:</strong> Todas las √≥rdenes del mercado<br>
                            ‚Ä¢ <strong>Actualizaci√≥n:</strong> Los datos se actualizan autom√°ticamente
                        </p>
                    </div>
                    
                    <div class="debug-section">
                        <h4>üß™ Herramientas de Prueba</h4>
                        <p style="font-size: 11px; line-height: 1.4; margin-bottom: 4px;">
                            ‚Ä¢ <strong>Producci√≥n:</strong> Simula producci√≥n para a√±adir inventario<br>
                            ‚Ä¢ <strong>√ìrdenes Debug:</strong> Tipos especiales para pruebas:<br>
                            &nbsp;&nbsp;- <strong>Normal:</strong> Orden regular de mercado<br>
                            &nbsp;&nbsp;- <strong>Auto-Accept:</strong> El servidor acepta autom√°ticamente<br>
                            &nbsp;&nbsp;- <strong>Team Only:</strong> Solo visible para tu equipo<br>
                            ‚Ä¢ <strong>Ping:</strong> Prueba conectividad con el servidor<br>
                            ‚Ä¢ <strong>Resync:</strong> Solicita resincronizaci√≥n de datos
                        </p>
                    </div>
                    
                    <div class="debug-section">
                        <h4>üíº Trading de Prueba</h4>
                        <p style="font-size: 11px; line-height: 1.4; margin-bottom: 4px;">
                            ‚Ä¢ <strong>Buy/Sell:</strong> Tipo de orden (compra/venta)<br>
                            ‚Ä¢ <strong>Market/Limit:</strong> Orden a mercado o con precio l√≠mite<br>
                            ‚Ä¢ <strong>Productos:</strong> FOSFO, PITA, PALTA-OIL, GUACA, SEBO, H-GUACA<br>
                            ‚Ä¢ <strong>Cantidad:</strong> N√∫mero de unidades a comerciar<br>
                            ‚Ä¢ <strong>Precio:</strong> Solo para √≥rdenes l√≠mite<br>
                            ‚Ä¢ <strong>Mensaje:</strong> Informaci√≥n adicional opcional
                        </p>
                    </div>
                    
                    <div class="debug-section">
                        <h4>üìã Tipos de Mensajes</h4>
                        <p style="font-size: 11px; line-height: 1.4; margin-bottom: 4px;">
                            ‚Ä¢ <strong>FILL:</strong> Orden ejecutada exitosamente<br>
                            ‚Ä¢ <strong>OFFER:</strong> Propuesta de venta dirigida<br>
                            ‚Ä¢ <strong>TICKER:</strong> Actualizaci√≥n de precios<br>
                            ‚Ä¢ <strong>ERROR:</strong> Mensaje de error del servidor<br>
                            ‚Ä¢ <strong>ORDER_ACK:</strong> Confirmaci√≥n de orden recibida<br>
                            ‚Ä¢ <strong>INVENTORY_UPDATE:</strong> Actualizaci√≥n de inventario
                        </p>
                    </div>
                    
                    <div class="debug-section">
                        <h4>üîç Depuraci√≥n de Cliente Java</h4>
                        <p style="font-size: 11px; line-height: 1.4; margin-bottom: 4px;">
                            1. <strong>Verificar Conexi√≥n:</strong> Tu cliente debe aparecer como "‚òï Java Client"<br>
                            2. <strong>Confirmar Autenticaci√≥n:</strong> Estado debe cambiar a "Authenticated"<br>
                            3. <strong>Probar √ìrdenes:</strong> Usa Auto-Accept para probar recepci√≥n de FILL<br>
                            4. <strong>Monitorear Mensajes:</strong> Observa todos los tipos de mensaje<br>
                            5. <strong>Verificar Inventario:</strong> Confirma que se actualiza correctamente<br>
                            6. <strong>Probar Ofertas:</strong> Acepta/rechaza ofertas para probar l√≥gica
                        </p>
                    </div>
                    
                    <div class="debug-section">
                        <h4>‚ö†Ô∏è Problemas Comunes</h4>
                        <p style="font-size: 11px; line-height: 1.4; margin-bottom: 4px;">
                            ‚Ä¢ <strong>No aparece Java Client:</strong> Verificar URL y token<br>
                            ‚Ä¢ <strong>Connected pero no Authenticated:</strong> Revisar formato del token<br>
                            ‚Ä¢ <strong>√ìrdenes no funcionan:</strong> Verificar inventario suficiente<br>
                            ‚Ä¢ <strong>Desconexiones frecuentes:</strong> Implementar reconexi√≥n autom√°tica<br>
                            ‚Ä¢ <strong>Mensajes perdidos:</strong> Verificar manejo de JSON en cliente
                        </p>
                    </div>
                    
                    <div class="debug-warning">
                        <strong>üí° Consejo:</strong> Mant√©n esta consola abierta mientras desarrollas tu cliente Java 
                        para monitorear conexiones, √≥rdenes y mensajes en tiempo real.
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Center Panel: Live Dashboard -->
        <div class="panel center-panel">
            <div class="tabs">
                <button class="tab active" onclick="switchMainTab('dashboard')">üìä Dashboard</button>
                <button class="tab" onclick="switchMainTab('ticker')">üìà Ticker</button>
                <button class="tab" onclick="switchMainTab('orderbook')">üìã Libro de √ìrdenes</button>
                <button class="tab" onclick="switchMainTab('transactions')">üìë Transacciones</button>
            </div>
            
            <!-- Live Dashboard -->
            <div id="dashboard-tab" class="tab-content active">
                <div class="feature-section">
                    <div class="feature-title">
                        <span>üìä</span>
                        <span>Dashboard en Vivo</span>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 16px;">
                        <div class="team-info">
                            <h4>üí∞ Estado Financiero</h4>
                            <p id="dashboard-balance">Balance: $--</p>
                            <p id="dashboard-profit">P&L: $--</p>
                            <p id="dashboard-volume">Volumen 24h: --</p>
                        </div>
                        <div class="team-info">
                            <h4>üìà Actividad del Mercado</h4>
                            <p id="dashboard-orders">√ìrdenes Activas: --</p>
                            <p id="dashboard-fills">Ejecuciones Hoy: --</p>
                            <p id="dashboard-connections">Conexiones: --</p>
                        </div>
                        <div class="team-info">
                            <h4>‚ö° Acciones R√°pidas</h4>
                            <p>Estado del Servidor: <span id="server-status">‚óè</span></p>
                            <p>√öltima Actualizaci√≥n: <span id="last-update">--</span></p>
                            <p>Latencia: <span id="ping-latency">--ms</span></p>
                        </div>
                    </div>
                    
                    <div class="team-info">
                        <h4>üèÜ Top Productos por Volumen</h4>
                        <div id="top-products">
                            <p>Cargando datos...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="ticker-tab" class="tab-content">
                <h3>üìà Ticker de Mercado en Vivo</h3>
                <div id="ticker-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px;">
                    <p style="grid-column: 1 / -1;">No hay datos de mercado disponibles</p>
                </div>
            </div>
            
            <div id="orderbook-tab" class="tab-content">
                <h3>üìã Libro de √ìrdenes</h3>
                <select id="product-selector" onchange="updateOrderBook()">
                    <option value="">Seleccionar Producto</option>
                    <option value="FOSFO">FOSFO</option>
                    <option value="PITA">PITA</option>
                    <option value="PALTA-OIL">PALTA-OIL</option>
                    <option value="GUACA">GUACA</option>
                    <option value="SEBO">SEBO</option>
                    <option value="H-GUACA">H-GUACA</option>
                </select>
                <div class="order-book-grid">
                    <div class="order-book-side buy">
                        <h5>üü¢ √ìRDENES DE COMPRA</h5>
                        <div id="buy-orders"></div>
                    </div>
                    <div class="order-book-side sell">
                        <h5>üî¥ √ìRDENES DE VENTA</h5>
                        <div id="sell-orders"></div>
                    </div>
                </div>
            </div>
            
            <!-- Transaction Log -->
            <div id="transactions-tab" class="tab-content">
                <div class="feature-section">
                    <div class="feature-title">
                        <span>üìë</span>
                        <span>Registro de Transacciones</span>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <div class="btn-group">
                            <button onclick="filterTransactions('all')" id="filter-all">Todas</button>
                            <button onclick="filterTransactions('fills')" id="filter-fills">Ejecuciones</button>
                            <button onclick="filterTransactions('orders')" id="filter-orders">√ìrdenes</button>
                            <button onclick="filterTransactions('offers')" id="filter-offers">Ofertas</button>
                            <button onclick="clearTransactionLog()" style="background: rgba(231, 76, 60, 0.3);">üóëÔ∏è Limpiar</button>
                        </div>
                    </div>
                    
                    <div class="transaction-log" id="transaction-log">
                        <p>No hay transacciones registradas</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Panel: Trading & Messages -->
        <div class="panel">
            <div class="tabs">
                <button class="tab active" onclick="switchRightTab('trading')">üíº Trading</button>
                <button class="tab" onclick="switchRightTab('orders')">üìã Mis √ìrdenes</button>
                <button class="tab" onclick="switchRightTab('messages')">üí¨ Mensajes</button>
            </div>
            
            <div id="trading-tab" class="tab-content active">
                <h3>üíº Realizar Orden</h3>
                <p style="font-size: 10px; opacity: 0.7; margin-bottom: 8px;">
                    üéØ TRADING DE DEPURACI√ìN - Usar para probar respuestas del mercado
                </p>
                <div class="form-row">
                    <select id="side">
                        <option value="BUY">üü¢ Comprar</option>
                        <option value="SELL">üî¥ Vender</option>
                    </select>
                    <select id="mode">
                        <option value="MARKET">üìà Mercado</option>
                        <option value="LIMIT">üéØ L√≠mite</option>
                    </select>
                </div>
                
                <select id="product">
                    <option value="FOSFO">FOSFO</option>
                    <option value="PITA">PITA</option>
                    <option value="PALTA-OIL">PALTA-OIL</option>
                    <option value="GUACA">GUACA</option>
                    <option value="SEBO">SEBO</option>
                    <option value="H-GUACA">H-GUACA</option>
                </select>
                
                <div class="form-row">
                    <input type="number" id="qty" placeholder="Cantidad" min="1" />
                    <input type="number" id="price" placeholder="Precio" step="0.01" />
                </div>
                
                <select id="debug-mode">
                    <option value="">Orden Normal</option>
                    <option value="AUTO_ACCEPT">Auto-Aceptar (Debug)</option>
                    <option value="TEAM_ONLY">Solo Equipo (Debug)</option>
                </select>
                
                <textarea id="message" placeholder="Mensaje opcional" rows="2"></textarea>
                <button id="place-order-btn" onclick="placeOrder()" disabled data-disabled-reason="Debe autenticarse para realizar √≥rdenes">üì§ Realizar Orden</button>
                
                <!-- Quick Trade Buttons -->
                <div class="feature-section" style="margin-top: 12px;">
                    <div class="feature-title">
                        <span>‚ö°</span>
                        <span>Trading R√°pido</span>
                    </div>
                    <div class="btn-group">
                        <button onclick="quickTrade('BUY', 'FOSFO', 10)" disabled id="quick-buy-fosfo" data-disabled-reason="Debe autenticarse para usar trading r√°pido">üü¢ Comprar 10 FOSFO</button>
                        <button onclick="quickTrade('SELL', 'FOSFO', 10)" disabled id="quick-sell-fosfo" data-disabled-reason="Debe autenticarse para usar trading r√°pido">üî¥ Vender 10 FOSFO</button>
                    </div>
                    <div class="btn-group">
                        <button onclick="quickTrade('BUY', 'PITA', 5)" disabled id="quick-buy-pita" data-disabled-reason="Debe autenticarse para usar trading r√°pido">üü¢ Comprar 5 PITA</button>
                        <button onclick="quickTrade('SELL', 'PITA', 5)" disabled id="quick-sell-pita" data-disabled-reason="Debe autenticarse para usar trading r√°pido">üî¥ Vender 5 PITA</button>
                    </div>
                </div>
            </div>
            
            <div id="orders-tab" class="tab-content">
                <h3>üìã Mis √ìrdenes</h3>
                <div class="btn-group">
                    <button onclick="refreshMyOrders()" disabled id="refresh-orders-btn" data-disabled-reason="Debe autenticarse para ver sus √≥rdenes">üîÑ Actualizar</button>
                    <button onclick="cancelAllOrders()" disabled id="cancel-all-btn" style="background: rgba(231, 76, 60, 0.3);" data-disabled-reason="Debe autenticarse para cancelar √≥rdenes">‚ùå Cancelar Todas</button>
                </div>
                <div id="my-orders-list">
                    <p>No hay √≥rdenes activas</p>
                </div>
                
                <!-- Order Statistics -->
                <div class="feature-section" style="margin-top: 12px;">
                    <div class="feature-title">
                        <span>üìä</span>
                        <span>Estad√≠sticas de √ìrdenes</span>
                    </div>
                    <div class="team-info">
                        <p id="orders-today">√ìrdenes Hoy: --</p>
                        <p id="fills-today">Ejecuciones Hoy: --</p>
                        <p id="success-rate">Tasa de √âxito: --%</p>
                        <p id="avg-fill-time">Tiempo Promedio de Ejecuci√≥n: --ms</p>
                    </div>
                </div>
            </div>
            
            <div id="messages-tab" class="tab-content">
                <h3>üí¨ Mensajes del Sistema</h3>
                <div class="btn-group">
                    <button onclick="clearMessages()">üóëÔ∏è Limpiar Mensajes</button>
                    <button onclick="exportMessages()">üì• Exportar</button>
                </div>
                <div class="messages" id="message-list"></div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let connected = false;
        let authenticated = false;
        let teamInfo = null;
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 5;
        let reconnectDelay = 1000;
        let pingInterval = null;
        let myOrders = new Map();
        let allOrders = [];
        let orderBook = { buy: [], sell: [] };
        let currentProduct = '';
        let connectedSessions = [];
        let serverStats = {};
        let autoMarketMaker = false;
        let transactionLog = [];
        let currentFilter = 'all';
        let orderStats = {
            ordersToday: 0,
            fillsToday: 0,
            totalOrders: 0,
            totalFills: 0,
            avgFillTime: 0
        };
        let productPrices = {
            'FOSFO': 10.00,
            'PITA': 15.00,
            'PALTA-OIL': 25.00,
            'GUACA': 35.00,
            'SEBO': 20.00,
            'H-GUACA': 50.00
        };
        
        // UI Elements
        const statusIndicator = document.getElementById('status-indicator');
        const connectBtn = document.getElementById('connect-btn');
        const loginBtn = document.getElementById('login-btn');
        const placeOrderBtn = document.getElementById('place-order-btn');
        const messageList = document.getElementById('message-list');
        const tickerList = document.getElementById('ticker-list');
        const connectionTime = document.getElementById('connection-time');
        const serverTime = document.getElementById('server-time');
        
        // Tab Management
        function switchTab(tabName) {
            console.log('Switching to tab:', tabName); // Debug logging
            
            // Find the panel containing this tab
            const panel = event.target.closest('.panel');
            if (!panel) {
                console.error('No panel found for tab');
                return;
            }
            
            // Only affect tabs within this panel
            panel.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            panel.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Activate clicked tab
            event.target.classList.add('active');
            
            // Activate corresponding tab content
            const targetTab = document.getElementById(`${tabName}-tab`);
            if (targetTab) {
                targetTab.classList.add('active');
                console.log('Successfully activated tab:', tabName);
            } else {
                console.error('Target tab not found:', `${tabName}-tab`);
            }
        }
        
        function switchMainTab(tabName) {
            // Find the center panel
            const centerPanel = document.querySelector('.center-panel');
            centerPanel.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            centerPanel.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }
        
        function switchRightTab(tabName) {
            const panel = event.target.closest('.panel');
            panel.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            panel.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }
        
        // Connection Management
        function toggleConnection() {
            if (connected) {
                disconnect();
            } else {
                connect();
            }
        }
        
        function connect() {
            if (ws) {
                ws.close();
            }
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            updateStatus('connecting', 'Connecting...');
            addMessage('info', 'Connecting to WebSocket...');
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                connected = true;
                reconnectAttempts = 0;
                updateStatus('connected', 'Connected');
                addMessage('success', 'WebSocket connected');
                connectBtn.textContent = 'Disconnect';
                loginBtn.disabled = false;
                connectionTime.textContent = `Connected: ${new Date().toLocaleTimeString()}`;
                startPing();
            };
            
            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handleMessage(data);
                } catch (e) {
                    addMessage('error', `Failed to parse message: ${e.message}`);
                }
            };
            
            ws.onclose = function(event) {
                connected = false;
                authenticated = false;
                stopPing();
                
                if (event.wasClean) {
                    updateStatus('disconnected', 'Disconnected');
                    addMessage('info', 'WebSocket disconnected cleanly');
                } else {
                    updateStatus('disconnected', 'Connection lost');
                    addMessage('error', `WebSocket disconnected unexpectedly: ${event.code}`);
                    
                    if (reconnectAttempts < maxReconnectAttempts) {
                        attemptReconnect();
                    } else {
                        addMessage('error', 'Max reconnection attempts reached');
                    }
                }
                
                connectBtn.textContent = 'Connect';
                loginBtn.disabled = true;
                disableDebugButtons();
                document.getElementById('team-info').style.display = 'none';
            };
            
            ws.onerror = function(error) {
                addMessage('error', `WebSocket error: ${error}`);
            };
        }
        
        function disconnect() {
            if (ws) {
                ws.close();
            }
        }
        
        function attemptReconnect() {
            reconnectAttempts++;
            const delay = reconnectDelay * Math.pow(2, reconnectAttempts - 1);
            
            updateStatus('connecting', `Reconnecting... (${reconnectAttempts}/${maxReconnectAttempts})`);
            addMessage('info', `Attempting reconnection ${reconnectAttempts}/${maxReconnectAttempts} in ${delay}ms`);
            
            setTimeout(() => {
                if (!connected) {
                    connect();
                }
            }, delay);
        }
        
        function startPing() {
            pingInterval = setInterval(() => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({type: 'PING'}));
                }
            }, 25000);
        }
        
        function stopPing() {
            if (pingInterval) {
                clearInterval(pingInterval);
                pingInterval = null;
            }
        }
        
        // Status Management
        function updateStatus(status, message) {
            updateConnectionStatus(status, message);
            updateButtonStates();
        }
        
        function addMessage(type, message) {
            const msg = document.createElement('div');
            msg.className = `message ${type}`;
            msg.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            messageList.appendChild(msg);
            messageList.scrollTop = messageList.scrollHeight;
        }
        
        // Authentication
        function login() {
            if (!handleUserAction('login', 'connected')) return;
            
            if (!validateForm('login')) return;
            
            const token = document.getElementById('token').value.trim();
            
            const loginMsg = {
                type: 'LOGIN',
                token: token
            };
            
            addMessage('info', `Intentando autenticaci√≥n con token: ${token}`);
            showAlert('Enviando credenciales de autenticaci√≥n...', 'info');
            ws.send(JSON.stringify(loginMsg));
        }
        
        // Message Handling
        function handleMessage(data) {
            switch (data.type) {
                case 'LOGIN_OK':
                    authenticated = true;
                    teamInfo = data;
                    updateStatus('authenticated', `Autenticado como ${data.team}`);
                    addMessage('success', `Conectado como ${data.team} (${data.species})`);
                    enableDebugButtons();
                    displayTeamInfo(data);
                    updateInventoryVisualizer(data.inventory);
                    updateDashboard();
                    requestAllOrders();
                    requestConnectedSessions();
                    addToTransactionLog('LOGIN', `Conectado como ${data.team}`, 'success');
                    break;
                    
                case 'ERROR':
                    addMessage('error', `${data.code}: ${data.reason}`);
                    if (data.clOrdID) {
                        updateMyOrderStatus(data.clOrdID, 'error', data.reason);
                    }
                    break;
                    
                case 'ORDER_ACK':
                    addMessage('success', `Order acknowledged: ${data.clOrdID}`);
                    updateMyOrderStatus(data.clOrdID, 'pending', 'Order acknowledged');
                    break;
                    
                case 'FILL':
                    addMessage('fill', `EJECUCI√ìN: ${data.fillQty} ${data.product} @ $${data.fillPrice} (${data.side}) - Contraparte: ${data.counterparty}`);
                    updateMyOrderStatus(data.clOrdID, 'filled', `Ejecutado ${data.fillQty}/${data.totalQty} @ $${data.fillPrice}`);
                    addToTransactionLog('FILL', `${data.side} ${data.fillQty} ${data.product} @ $${data.fillPrice}`, 'fill');
                    updateOrderStats('fill');
                    updateDashboard();
                    break;
                    
                case 'TICKER':
                    updateTicker(data);
                    if (data.serverTime) {
                        serverTime.textContent = `Server: ${new Date(data.serverTime).toLocaleTimeString()}`;
                    }
                    break;
                    
                case 'OFFER':
                    addMessage('info', `OFERTA: ${data.buyer} quiere ${data.quantityRequested} ${data.product} @ m√°x $${data.maxPrice}`);
                    displayOffer(data);
                    addToTransactionLog('OFFER', `${data.buyer} solicita ${data.quantityRequested} ${data.product} @ m√°x $${data.maxPrice}`, 'offer');
                    break;
                    
                case 'INVENTORY_UPDATE':
                    updateInventoryDisplay(data.inventory);
                    addMessage('info', 'Inventory updated');
                    break;
                    
                case 'ALL_ORDERS':
                    allOrders = data.orders;
                    updateAllOrdersDisplay();
                    break;
                    
                case 'ORDER_BOOK_UPDATE':
                    if (data.product === currentProduct) {
                        updateOrderBookDisplay(data);
                    }
                    break;
                    
                case 'CONNECTED_SESSIONS':
                    connectedSessions = data.sessions;
                    updateSessionsDisplay();
                    break;
                    
                case 'SERVER_STATS':
                    serverStats = data.stats;
                    updateServerStatsDisplay();
                    break;
                    
                case 'PONG':
                    break;
                    
                case 'ECHO':
                    addMessage('info', `Echo: ${JSON.stringify(data.original)}`);
                    break;
                    
                default:
                    addMessage('info', `${data.type}: ${JSON.stringify(data)}`);
            }
        }
        
        // Display Functions
        function displayTeamInfo(data) {
            const teamInfoEl = document.getElementById('team-info');
            const teamDetailsEl = document.getElementById('team-details');
            
            const inventoryHtml = data.inventory ? 
                Object.entries(data.inventory)
                    .filter(([product, qty]) => qty > 0)
                    .map(([product, qty]) => `${product}: ${qty}`)
                    .join(', ') || 'Sin inventario' 
                : 'Sin inventario';
            
            teamDetailsEl.innerHTML = `
                <p><strong>Equipo:</strong> ${data.team}</p>
                <p><strong>Especie:</strong> ${data.species}</p>
                <p><strong>Balance:</strong> $${data.currentBalance || data.initialBalance}</p>
                <p><strong>Inventario:</strong> ${inventoryHtml}</p>
                <p><strong>Autorizados:</strong> ${data.authorizedProducts.join(', ')}</p>
            `;
            teamInfoEl.style.display = 'block';
        }
        
        function updateInventoryDisplay(inventory) {
            if (!teamInfo) return;
            teamInfo.inventory = inventory;
            displayTeamInfo(teamInfo);
        }
        
        function updateTicker(ticker) {
            let tickerItem = document.querySelector(`[data-product="${ticker.product}"]`);
            
            if (!tickerItem) {
                tickerItem = document.createElement('div');
                tickerItem.className = 'ticker-item';
                tickerItem.setAttribute('data-product', ticker.product);
                tickerList.appendChild(tickerItem);
            }
            
            tickerItem.innerHTML = `
                <div class="order-header">
                    <span class="product">${ticker.product}</span>
                    <span class="price">
                        <span class="price-bid">$${ticker.bestBid || 'N/A'}</span> | 
                        <span class="price-ask">$${ticker.bestAsk || 'N/A'}</span> | 
                        <span class="price-mid">$${ticker.mid || 'N/A'}</span>
                    </span>
                </div>
                <div class="order-details">Vol: ${ticker.volume24h || 0}</div>
            `;
        }
        
        function updateAllOrdersDisplay() {
            const container = document.getElementById('all-orders-list');
            
            if (allOrders.length === 0) {
                container.innerHTML = '<p>No hay √≥rdenes disponibles</p>';
                return;
            }
            
            container.innerHTML = allOrders.map(order => {
                const priceText = order.mode === 'LIMIT' && order.price ? `@ $${order.price}` : '@ Market';
                const progress = order.filledQty > 0 ? ` (${order.filledQty}/${order.quantity} filled)` : '';
                
                return `
                    <div class="order-item ${order.side.toLowerCase()}">
                        <div class="order-header">
                            <strong>${order.teamName}</strong>
                            <span>${order.side} ${order.quantity} ${order.product}</span>
                        </div>
                        <div class="order-details">
                            ${order.mode} ${priceText}${progress}
                            ${order.message ? `| "${order.message}"` : ''}
                        </div>
                        ${teamInfo && teamInfo.team !== order.teamName ? `
                            <div style="margin-top: 6px;">
                                <button class="btn-small" onclick="respondToOrder('${order.clOrdID}', true)">Aceptar</button>
                                <button class="btn-small" onclick="respondToOrder('${order.clOrdID}', false)">Rechazar</button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        function updateOrderBookDisplay(data) {
            const buyContainer = document.getElementById('buy-orders');
            const sellContainer = document.getElementById('sell-orders');
            
            buyContainer.innerHTML = data.buyOrders.map(order => `
                <div class="order-book-entry">
                    <span>${order.quantity}@${order.price || 'MKT'}</span>
                    <span>${order.teamName}</span>
                </div>
            `).join('') || '<p>No buy orders</p>';
            
            sellContainer.innerHTML = data.sellOrders.map(order => `
                <div class="order-book-entry">
                    <span>${order.quantity}@${order.price || 'MKT'}</span>
                    <span>${order.teamName}</span>
                </div>
            `).join('') || '<p>No sell orders</p>';
        }
        
        function displayOffer(offer) {
            const container = document.getElementById('all-orders-list');
            
            const offerElement = document.createElement('div');
            offerElement.className = 'order-item pending';
            offerElement.innerHTML = `
                <div class="order-header">
                    <strong>OFFER: ${offer.buyer}</strong>
                    <span>${offer.quantityRequested} ${offer.product} @ max $${offer.maxPrice}</span>
                </div>
                <div class="order-details">
                    Offer ID: ${offer.offerId} | Expires in: ${offer.expiresIn}ms
                </div>
                <div style="margin-top: 6px;" id="offer-actions-${offer.offerId}">
                    <button class="btn-small" onclick="respondToOffer('${offer.offerId}', true)">Approve</button>
                    <button class="btn-small" onclick="respondToOffer('${offer.offerId}', false)">Deny</button>
                </div>
            `;
            
            container.insertBefore(offerElement, container.firstChild);
            
            if (offer.expiresIn) {
                setTimeout(() => {
                    if (offerElement.parentNode) {
                        offerElement.remove();
                    }
                }, offer.expiresIn);
            }
        }
        
        // Order Management
        function placeOrder() {
            if (!authenticated) {
                addMessage('error', 'Must be authenticated to place orders');
                return;
            }
            
            const side = document.getElementById('side').value;
            const mode = document.getElementById('mode').value;
            const product = document.getElementById('product').value;
            const qty = parseInt(document.getElementById('qty').value);
            const price = parseFloat(document.getElementById('price').value);
            const message = document.getElementById('message').value;
            const debugMode = document.getElementById('debug-mode').value;
            
            if (!qty || qty <= 0) {
                addMessage('error', 'Please enter a valid quantity');
                return;
            }
            
            if (mode === 'LIMIT' && (!price || price <= 0)) {
                addMessage('error', 'Please enter a valid price for limit orders');
                return;
            }
            
            const clOrdID = `ORD-${teamInfo.team}-${Date.now()}-${Math.random().toString(36).substr(2, 8)}`;
            
            const orderMsg = {
                type: 'ORDER',
                clOrdID: clOrdID,
                side: side,
                mode: mode,
                product: product,
                qty: qty,
                message: message || undefined,
                debugMode: debugMode || undefined
            };
            
            if (mode === 'LIMIT') {
                orderMsg.limitPrice = price;
            }
            
            addMessage('info', `Placing ${side} order: ${qty} ${product} @ ${mode}${debugMode ? ` (${debugMode})` : ''}`);
            ws.send(JSON.stringify(orderMsg));
            
            addMyOrder(clOrdID, side, mode, product, qty, price, message, debugMode);
            
            // Clear form
            document.getElementById('qty').value = '';
            document.getElementById('price').value = '';
            document.getElementById('message').value = '';
        }
        
        function addMyOrder(clOrdID, side, mode, product, qty, price, message, debugMode) {
            const order = {
                clOrdID, side, mode, product, qty, price, message, debugMode,
                status: 'submitted',
                timestamp: new Date(),
                statusText: 'Submitted to server'
            };
            
            myOrders.set(clOrdID, order);
            updateMyOrdersDisplay();
        }
        
        function updateMyOrderStatus(clOrdID, status, statusText) {
            const order = myOrders.get(clOrdID);
            if (order) {
                order.status = status;
                order.statusText = statusText;
                order.lastUpdate = new Date();
                updateMyOrdersDisplay();
            }
        }
        
        function updateMyOrdersDisplay() {
            const container = document.getElementById('my-orders-list');
            
            if (myOrders.size === 0) {
                container.innerHTML = '<p>No active orders</p>';
                return;
            }
            
            const orderArray = Array.from(myOrders.values()).sort((a, b) => b.timestamp - a.timestamp);
            
            container.innerHTML = orderArray.map(order => {
                const priceText = order.mode === 'LIMIT' && order.price ? `@ $${order.price}` : '@ Market';
                const timeText = order.timestamp.toLocaleTimeString();
                const debugText = order.debugMode ? ` [${order.debugMode}]` : '';
                
                return `
                    <div class="order-item ${order.side.toLowerCase()} ${order.status}">
                        <div class="order-header">
                            <strong>${order.side} ${order.qty} ${order.product}</strong>
                            <span>${timeText}</span>
                        </div>
                        <div class="order-details">
                            ${order.mode} ${priceText}${debugText} | ${order.statusText}
                            ${order.message ? `| "${order.message}"` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Debug Functions
        function enableDebugButtons() {
            document.getElementById('prod-btn').disabled = false;
            document.getElementById('all-orders-btn').disabled = false;
            document.getElementById('order-book-btn').disabled = false;
            document.getElementById('ping-btn').disabled = false;
            document.getElementById('resync-btn').disabled = false;
            document.getElementById('sessions-btn').disabled = false;
            document.getElementById('place-order-btn').disabled = false;
        }
        
        function disableDebugButtons() {
            document.getElementById('prod-btn').disabled = true;
            document.getElementById('all-orders-btn').disabled = true;
            document.getElementById('order-book-btn').disabled = true;
            document.getElementById('ping-btn').disabled = true;
            document.getElementById('resync-btn').disabled = true;
            document.getElementById('sessions-btn').disabled = true;
            document.getElementById('place-order-btn').disabled = true;
        }
        
        function testProduction() {
            const product = document.getElementById('prod-product').value;
            const qty = parseInt(document.getElementById('prod-qty').value);
            
            if (!qty || qty <= 0) {
                addMessage('error', 'Please enter a valid quantity');
                return;
            }
            
            const prodMsg = {
                type: 'PRODUCTION_UPDATE',
                product: product,
                quantity: qty
            };
            
            addMessage('info', `Testing production: ${qty} ${product}`);
            ws.send(JSON.stringify(prodMsg));
            
            document.getElementById('prod-qty').value = '';
        }
        
        function requestAllOrders() {
            const msg = { type: 'REQUEST_ALL_ORDERS' };
            ws.send(JSON.stringify(msg));
        }
        
        function requestOrderBook() {
            const product = document.getElementById('product-selector').value;
            if (!product) {
                addMessage('error', 'Please select a product first');
                return;
            }
            
            const msg = { type: 'REQUEST_ORDER_BOOK', product: product };
            ws.send(JSON.stringify(msg));
        }
        
        function updateOrderBook() {
            const product = document.getElementById('product-selector').value;
            currentProduct = product;
            
            if (product) {
                requestOrderBook();
            } else {
                document.getElementById('buy-orders').innerHTML = '<p>Select a product</p>';
                document.getElementById('sell-orders').innerHTML = '<p>Select a product</p>';
            }
        }
        
        function sendPing() {
            const msg = { type: 'PING' };
            ws.send(JSON.stringify(msg));
            addMessage('info', 'Ping sent');
        }
        
        function requestResync() {
            const msg = { type: 'RESYNC', lastSync: '' };
            ws.send(JSON.stringify(msg));
            addMessage('info', 'Resync requested');
        }
        
        function respondToOffer(offerId, accept) {
            if (!authenticated) {
                addMessage('error', 'Must be authenticated to respond to offers');
                return;
            }
            
            const response = {
                type: 'ACCEPT_OFFER',
                offerId: offerId,
                accept: accept
            };
            
            ws.send(JSON.stringify(response));
            
            const actionsEl = document.getElementById(`offer-actions-${offerId}`);
            if (actionsEl) {
                actionsEl.innerHTML = `<span style="color: ${accept ? '#2ecc71' : '#e74c3c'};">${accept ? 'APPROVED' : 'DENIED'}</span>`;
            }
            
            addMessage('info', `Offer ${offerId} ${accept ? 'approved' : 'denied'}`);
        }
        
        function respondToOrder(clOrdID, accept) {
            addMessage('info', `Order response not implemented yet: ${clOrdID} ${accept ? 'accepted' : 'rejected'}`);
        }
        
        function requestConnectedSessions() {
            const msg = { type: 'REQUEST_CONNECTED_SESSIONS' };
            ws.send(JSON.stringify(msg));
            addMessage('info', 'Requesting connected sessions...');
        }
        
        function updateSessionsDisplay() {
            const container = document.getElementById('sessions-list');
            
            if (connectedSessions.length === 0) {
                container.innerHTML = '<p>No connected sessions</p>';
                return;
            }
            
            container.innerHTML = connectedSessions.map(session => {
                const connectionTime = new Date(session.connectedAt).toLocaleTimeString();
                
                // Determine display based on client type
                let clientIcon = '‚òï';
                let clientText = 'Java Client';
                let statusClass = session.authenticated ? 'authenticated' : 'connected';
                let clientClass = 'java-client';
                
                if (session.clientType === 'Multiple Clients') {
                    clientIcon = 'üîó';
                    clientText = 'Multiple Clients';
                    statusClass = 'authenticated';
                    clientClass = 'multiple-clients';
                } else if (session.clientType === 'Web Browser') {
                    clientIcon = 'üåê';
                    clientText = 'Web Browser';
                    clientClass = 'web-client';
                }
                
                return `
                    <div class="session-item ${statusClass} ${clientClass}">
                        <div class="order-header">
                            <strong>${session.teamName || 'Anonymous'}</strong>
                            <span>${clientIcon} ${clientText}</span>
                        </div>
                        <div class="order-details">
                            Connected: ${connectionTime} | 
                            Status: ${session.authenticated ? 'Authenticated' : 'Connected'} | 
                            ${session.remoteAddr}
                            ${session.lastActivity ? `| Last Activity: ${new Date(session.lastActivity).toLocaleTimeString()}` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function updateServerStatsDisplay() {
            if (serverStats.totalConnections !== undefined) {
                document.getElementById('total-connections').textContent = `Total Connections: ${serverStats.totalConnections}`;
            }
            if (serverStats.totalOrders !== undefined) {
                document.getElementById('total-orders').textContent = `Total Orders: ${serverStats.totalOrders}`;
            }
            if (serverStats.totalFills !== undefined) {
                document.getElementById('total-fills').textContent = `Total Fills: ${serverStats.totalFills}`;
            }
            if (serverStats.uptime !== undefined) {
                document.getElementById('server-uptime').textContent = `Server Uptime: ${serverStats.uptime}`;
            }
        }
        
        // Initialize tooltips and enhanced features
        function initializeEnhancements() {
            addFormTooltips();
            updateButtonStates();
            
            // Test docs tab visibility
            const docsTab = document.getElementById('docs-tab');
            if (docsTab) {
                console.log('Docs tab found, content length:', docsTab.innerHTML.length);
            } else {
                console.error('Docs tab not found!');
            }
            
            // Add helpful hints to the interface
            setTimeout(() => {
                if (!connected) {
                    showAlert('¬°Bienvenido! Comience haciendo clic en "Conectar" para establecer conexi√≥n con el servidor.', 'info', 5000);
                }
            }, 1000);
        }
        
        // Auto-connect on page load
        window.onload = function() {
            initializeEnhancements();
            // Clean up old orders periodically
            setInterval(() => {
                const cutoff = new Date(Date.now() - 300000); // 5 minutes ago
                for (const [clOrdID, order] of myOrders.entries()) {
                    if (order.status === 'filled' || order.status === 'error') {
                        if (order.timestamp < cutoff) {
                            myOrders.delete(clOrdID);
                        }
                    }
                }
                updateMyOrdersDisplay();
            }, 60000);
            
            // Auto-refresh sessions every 10 seconds if authenticated
            setInterval(() => {
                if (authenticated && ws && ws.readyState === WebSocket.OPEN) {
                    requestConnectedSessions();
                }
            }, 10000);
        };
        
        // Handle Enter key in forms
        document.getElementById('token').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (!connected) {
                    connect();
                } else {
                    login();
                }
            }
        });
        
        ['qty', 'price'].forEach(id => {
            document.getElementById(id).addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    placeOrder();
                }
            });
        });
        
        document.getElementById('prod-qty').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                testProduction();
            }
        });

        // New Features Implementation
        
        // Market Simulator Functions
        function createMarketOrder() {
            if (!handleUserAction('createMarketOrder', 'authenticated')) return;
            
            if (!validateForm('market-order')) return;
            
            const side = document.getElementById('sim-side').value;
            const product = document.getElementById('sim-product').value;
            const qty = parseInt(document.getElementById('sim-qty').value);
            const price = parseFloat(document.getElementById('sim-price').value);
            
            const clOrdID = `SIM-${teamInfo.team}-${Date.now()}-${Math.random().toString(36).substr(2, 8)}`;
            
            const orderMsg = {
                type: 'ORDER',
                clOrdID: clOrdID,
                side: side,
                mode: 'LIMIT',
                product: product,
                qty: qty,
                limitPrice: price,
                message: 'üéØ Orden del Simulador de Mercado',
                debugMode: 'MARKET_SIMULATOR'
            };
            
            addMessage('info', `Creando orden de mercado: ${side} ${qty} ${product} @ $${price}`);
            showAlert(`Orden creada: ${side} ${qty} ${product} @ $${price}`, 'success');
            ws.send(JSON.stringify(orderMsg));
            addToTransactionLog('MARKET_ORDER', `${side} ${qty} ${product} @ $${price}`, 'order');
            
            // Clear form
            document.getElementById('sim-qty').value = '';
            document.getElementById('sim-price').value = '';
        }
        
        function updatePrice(product, value) {
            productPrices[product] = parseFloat(value);
            document.getElementById(`${product.toLowerCase().replace('-', '-')}-price`).textContent = parseFloat(value).toFixed(2);
            
            // Auto-create counter orders if auto market maker is enabled
            if (autoMarketMaker && authenticated) {
                createCounterOrders(product, parseFloat(value));
            }
        }
        
        function toggleAutoMarketMaker() {
            autoMarketMaker = !autoMarketMaker;
            const btn = document.getElementById('auto-mm-btn');
            
            if (autoMarketMaker) {
                btn.textContent = 'üî¥ Desactivar Auto-MM';
                btn.style.background = 'rgba(231, 76, 60, 0.3)';
                addMessage('success', 'Auto Market Maker activado');
            } else {
                btn.textContent = 'üü¢ Activar Auto-MM';
                btn.style.background = 'rgba(46, 204, 113, 0.3)';
                addMessage('info', 'Auto Market Maker desactivado');
            }
        }
        
        function createCounterOrders(product, basePrice) {
            if (!authenticated) return;
            
            // Create buy order 5% below
            const buyPrice = (basePrice * 0.95).toFixed(2);
            const buyOrderMsg = {
                type: 'ORDER',
                clOrdID: `AMM-BUY-${Date.now()}`,
                side: 'BUY',
                mode: 'LIMIT',
                product: product,
                qty: 5,
                limitPrice: parseFloat(buyPrice),
                message: 'ü§ñ Auto Market Maker - Compra',
                debugMode: 'AUTO_MARKET_MAKER'
            };
            
            // Create sell order 5% above
            const sellPrice = (basePrice * 1.05).toFixed(2);
            const sellOrderMsg = {
                type: 'ORDER',
                clOrdID: `AMM-SELL-${Date.now()}`,
                side: 'SELL',
                mode: 'LIMIT',
                product: product,
                qty: 5,
                limitPrice: parseFloat(sellPrice),
                message: 'ü§ñ Auto Market Maker - Venta',
                debugMode: 'AUTO_MARKET_MAKER'
            };
            
            setTimeout(() => ws.send(JSON.stringify(buyOrderMsg)), 100);
            setTimeout(() => ws.send(JSON.stringify(sellOrderMsg)), 200);
        }
        
        function clearAllOrders() {
            if (!authenticated) {
                addMessage('error', 'Debe estar autenticado para limpiar √≥rdenes');
                return;
            }
            
            const clearMsg = { type: 'CLEAR_ALL_ORDERS' };
            ws.send(JSON.stringify(clearMsg));
            addMessage('info', 'Solicitando limpieza de todas las √≥rdenes');
        }
        
        // Error Injection Functions
        function injectError(errorType) {
            if (!authenticated) {
                addMessage('error', 'Debe estar autenticado para inyectar errores');
                return;
            }
            
            const errorMsg = {
                type: 'INJECT_ERROR',
                errorType: errorType
            };
            
            ws.send(JSON.stringify(errorMsg));
            
            const errorNames = {
                'INSUFFICIENT_BALANCE': 'Saldo Insuficiente',
                'UNAUTHORIZED_PRODUCT': 'Producto No Autorizado',
                'DISCONNECT_CLIENT': 'Desconectar Cliente',
                'OFFER_EXPIRED': 'Expirar Oferta'
            };
            
            addMessage('error', `Inyectando error: ${errorNames[errorType]}`);
            addToTransactionLog('ERROR_INJECTION', errorNames[errorType], 'error');
        }
        
        // Production Validator Functions
        function testProduction() {
            const product = document.getElementById('prod-product').value;
            const qty = parseInt(document.getElementById('prod-qty').value);
            
            if (!qty || qty <= 0) {
                addMessage('error', 'Por favor ingrese una cantidad v√°lida');
                return;
            }
            
            // Simulate algorithm calculation
            const algorithmResult = calculateProductionAlgorithm(product, qty);
            
            const prodMsg = {
                type: 'PRODUCTION_UPDATE',
                product: product,
                quantity: qty
            };
            
            addMessage('info', `Probando producci√≥n: ${qty} ${product}`);
            ws.send(JSON.stringify(prodMsg));
            
            // Display production validation
            displayProductionValidation(product, qty, algorithmResult);
            addToTransactionLog('PRODUCTION', `${qty} ${product}`, 'production');
            
            document.getElementById('prod-qty').value = '';
        }
        
        function calculateProductionAlgorithm(product, quantity) {
            // Simulate production algorithm
            const branches = 2;
            const maxDepth = 4;
            const decay = 0.7651;
            const baseEnergy = 3.0;
            const levelEnergy = 2.0;
            
            // Simple calculation (this would be more complex in real implementation)
            const expectedQty = Math.floor(baseEnergy * levelEnergy * decay * branches);
            
            return {
                branches,
                maxDepth,
                decay,
                baseEnergy,
                levelEnergy,
                expectedQty,
                actualQty: quantity,
                isCorrect: Math.abs(expectedQty - quantity) <= 2,
                premiumBonus: quantity > expectedQty
            };
        }
        
        function displayProductionValidation(product, quantity, algorithm) {
            const resultEl = document.getElementById('production-result');
            const receivedEl = document.getElementById('prod-received');
            const algorithmEl = document.getElementById('prod-algorithm');
            const validationEl = document.getElementById('prod-validation');
            const premiumEl = document.getElementById('prod-premium');
            
            receivedEl.textContent = `${quantity} ${product} (b√°sico)`;
            algorithmEl.innerHTML = `
                branches=${algorithm.branches}, maxDepth=${algorithm.maxDepth}, decay=${algorithm.decay}<br>
                baseEnergy=${algorithm.baseEnergy}, levelEnergy=${algorithm.levelEnergy}<br>
                ‚Üí Resultado: ${algorithm.expectedQty} unidades
            `;
            validationEl.innerHTML = algorithm.isCorrect ? 
                '‚úÖ CORRECTO' : 
                `‚ùå INCORRECTO (esperado: ${algorithm.expectedQty})`;
            validationEl.style.color = algorithm.isCorrect ? '#2ecc71' : '#e74c3c';
            premiumEl.textContent = algorithm.premiumBonus ? 'S√ç' : 'NO';
            premiumEl.style.color = algorithm.premiumBonus ? '#f39c12' : '#95a5a6';
            
            resultEl.style.display = 'block';
        }
        
        // Offer Tester Functions
        function sendTestOffer() {
            if (!authenticated) {
                addMessage('error', 'Debe estar autenticado para enviar ofertas');
                return;
            }
            
            const product = document.getElementById('offer-product').value;
            const qty = parseInt(document.getElementById('offer-qty').value);
            const maxPrice = parseFloat(document.getElementById('offer-max-price').value);
            const message = document.getElementById('offer-message').value;
            
            if (!qty || qty <= 0) {
                addMessage('error', 'Por favor ingrese una cantidad v√°lida');
                return;
            }
            
            if (!maxPrice || maxPrice <= 0) {
                addMessage('error', 'Por favor ingrese un precio m√°ximo v√°lido');
                return;
            }
            
            const offerId = `OFFER-${Date.now()}`;
            const offerMsg = {
                type: 'SEND_OFFER',
                offerId: offerId,
                product: product,
                quantityRequested: qty,
                maxPrice: maxPrice,
                message: message || '¬°Urgente! Necesario para producci√≥n premium'
            };
            
            ws.send(JSON.stringify(offerMsg));
            addMessage('info', `Enviando oferta: ${qty} ${product} @ m√°x $${maxPrice}`);
            
            // Start response timer
            startOfferTimer(offerId);
            addToTransactionLog('OFFER_SENT', `${qty} ${product} @ m√°x $${maxPrice}`, 'offer');
        }
        
        function startOfferTimer(offerId) {
            const responseEl = document.getElementById('offer-response');
            const timerEl = document.getElementById('response-timer');
            const statusEl = document.getElementById('offer-status');
            
            responseEl.style.display = 'block';
            statusEl.textContent = 'Pendiente...';
            
            let startTime = Date.now();
            const timer = setInterval(() => {
                const elapsed = Date.now() - startTime;
                timerEl.textContent = `${elapsed}ms`;
                
                if (elapsed > 30000) { // 30 second timeout
                    clearInterval(timer);
                    statusEl.textContent = 'Tiempo agotado';
                    statusEl.style.color = '#e74c3c';
                }
            }, 100);
            
            // Store timer to clear it if response comes
            window.currentOfferTimer = timer;
        }
        
        // Transaction Log Functions
        function addToTransactionLog(type, description, category) {
            const transaction = {
                id: Date.now(),
                timestamp: new Date(),
                type: type,
                description: description,
                category: category
            };
            
            transactionLog.unshift(transaction);
            
            // Keep only last 1000 transactions
            if (transactionLog.length > 1000) {
                transactionLog = transactionLog.slice(0, 1000);
            }
            
            updateTransactionLogDisplay();
        }
        
        function updateTransactionLogDisplay() {
            const container = document.getElementById('transaction-log');
            
            const filteredLog = transactionLog.filter(tx => {
                if (currentFilter === 'all') return true;
                if (currentFilter === 'fills') return tx.category === 'fill';
                if (currentFilter === 'orders') return tx.category === 'order';
                if (currentFilter === 'offers') return tx.category === 'offer';
                return true;
            });
            
            if (filteredLog.length === 0) {
                container.innerHTML = '<p>No hay transacciones registradas</p>';
                return;
            }
            
            container.innerHTML = filteredLog.slice(0, 50).map(tx => {
                const timeStr = tx.timestamp.toLocaleTimeString();
                const categoryIcon = {
                    'fill': 'üí∞',
                    'order': 'üìã',
                    'offer': 'üéØ',
                    'error': '‚ùå',
                    'success': '‚úÖ',
                    'production': 'üè≠'
                }[tx.category] || 'üìù';
                
                return `
                    <div class="message ${tx.category}" style="margin-bottom: 4px;">
                        <strong>[${timeStr}] ${categoryIcon} ${tx.type}:</strong> ${tx.description}
                    </div>
                `;
            }).join('');
        }
        
        function filterTransactions(filter) {
            currentFilter = filter;
            
            // Update button states
            document.querySelectorAll('#transactions-tab .btn-group button').forEach(btn => {
                btn.style.background = 'rgba(52, 152, 219, 0.3)';
            });
            document.getElementById(`filter-${filter}`).style.background = 'rgba(52, 152, 219, 0.5)';
            
            updateTransactionLogDisplay();
        }
        
        function clearTransactionLog() {
            transactionLog = [];
            updateTransactionLogDisplay();
            addMessage('info', 'Registro de transacciones limpiado');
        }
        
        // Dashboard Functions
        function updateDashboard() {
            if (!teamInfo) return;
            
            document.getElementById('dashboard-balance').textContent = 
                `Balance: $${teamInfo.currentBalance || teamInfo.initialBalance || '--'}`;
            
            const profit = teamInfo.currentBalance ? 
                (teamInfo.currentBalance - teamInfo.initialBalance).toFixed(2) : '--';
            document.getElementById('dashboard-profit').textContent = `P&L: $${profit}`;
            
            document.getElementById('dashboard-volume').textContent = 
                `Volumen 24h: ${calculateVolume24h()}`;
            
            document.getElementById('dashboard-orders').textContent = 
                `√ìrdenes Activas: ${myOrders.size}`;
            
            document.getElementById('dashboard-fills').textContent = 
                `Ejecuciones Hoy: ${orderStats.fillsToday}`;
            
            document.getElementById('dashboard-connections').textContent = 
                `Conexiones: ${connectedSessions.length}`;
            
            // Update server status indicators
            const serverStatusEl = document.getElementById('server-status');
            const lastUpdateEl = document.getElementById('last-update');
            
            if (serverStatusEl) {
                if (authenticated) {
                    serverStatusEl.textContent = 'üü¢';
                    serverStatusEl.style.color = '#2ecc71';
                } else if (connected) {
                    serverStatusEl.textContent = 'üü°';
                    serverStatusEl.style.color = '#f39c12';
                } else {
                    serverStatusEl.textContent = 'üî¥';
                    serverStatusEl.style.color = '#e74c3c';
                }
            }
            
            if (lastUpdateEl) {
                lastUpdateEl.textContent = new Date().toLocaleTimeString();
            }
            
            updateTopProducts();
        }
        
        function calculateVolume24h() {
            // Calculate from transaction log
            const now = new Date();
            const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            
            return transactionLog
                .filter(tx => tx.timestamp > yesterday && tx.category === 'fill')
                .length;
        }
        
        function updateTopProducts() {
            const productVolumes = {};
            
            transactionLog
                .filter(tx => tx.category === 'fill')
                .forEach(tx => {
                    const match = tx.description.match(/(\w+)/);
                    if (match) {
                        const product = match[1];
                        productVolumes[product] = (productVolumes[product] || 0) + 1;
                    }
                });
            
            const sorted = Object.entries(productVolumes)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 3);
            
            const container = document.getElementById('top-products');
            
            if (sorted.length === 0) {
                container.innerHTML = '<p>No hay datos de volumen</p>';
                return;
            }
            
            container.innerHTML = sorted.map(([product, volume], index) => {
                const medal = ['ü•á', 'ü•à', 'ü•â'][index];
                return `<p>${medal} ${product}: ${volume} ejecuciones</p>`;
            }).join('');
        }
        
        // Inventory Visualizer
        function updateInventoryVisualizer(inventory) {
            const container = document.getElementById('inventory-visualizer');
            
            if (!inventory || Object.keys(inventory).length === 0) {
                container.innerHTML = '<div class="inventory-item">Sin inventario</div>';
                return;
            }
            
            container.innerHTML = Object.entries(inventory)
                .map(([product, qty]) => `
                    <div class="inventory-item">
                        <strong>${product}</strong><br>
                        <span style="font-size: 14px; color: #f39c12;">${qty}</span>
                    </div>
                `).join('');
        }
        
        // Quick Trade Functions
        function quickTrade(side, product, qty) {
            if (!authenticated) {
                addMessage('error', 'Debe estar autenticado para realizar trading r√°pido');
                return;
            }
            
            const clOrdID = `QUICK-${side}-${Date.now()}`;
            const orderMsg = {
                type: 'ORDER',
                clOrdID: clOrdID,
                side: side,
                mode: 'MARKET',
                product: product,
                qty: qty,
                message: `‚ö° Trading R√°pido`,
                debugMode: 'QUICK_TRADE'
            };
            
            ws.send(JSON.stringify(orderMsg));
            addMessage('info', `Trading r√°pido: ${side} ${qty} ${product}`);
            addToTransactionLog('QUICK_TRADE', `${side} ${qty} ${product}`, 'order');
        }
        
        // Order Management Functions
        function refreshMyOrders() {
            updateMyOrdersDisplay();
            addMessage('info', '√ìrdenes actualizadas');
        }
        
        function cancelAllOrders() {
            if (!authenticated) {
                addMessage('error', 'Debe estar autenticado para cancelar √≥rdenes');
                return;
            }
            
            const cancelMsg = { type: 'CANCEL_ALL_ORDERS' };
            ws.send(JSON.stringify(cancelMsg));
            addMessage('info', 'Solicitando cancelaci√≥n de todas las √≥rdenes');
        }
        
        function updateOrderStats(action) {
            if (action === 'order') {
                orderStats.ordersToday++;
                orderStats.totalOrders++;
            } else if (action === 'fill') {
                orderStats.fillsToday++;
                orderStats.totalFills++;
            }
            
            // Update display
            document.getElementById('orders-today').textContent = `√ìrdenes Hoy: ${orderStats.ordersToday}`;
            document.getElementById('fills-today').textContent = `Ejecuciones Hoy: ${orderStats.fillsToday}`;
            
            const successRate = orderStats.totalOrders > 0 ? 
                ((orderStats.totalFills / orderStats.totalOrders) * 100).toFixed(1) : 0;
            document.getElementById('success-rate').textContent = `Tasa de √âxito: ${successRate}%`;
        }
        
        // Message Management
        function clearMessages() {
            messageList.innerHTML = '';
            addMessage('info', 'Mensajes limpiados');
        }
        
        function exportMessages() {
            const messages = Array.from(messageList.children).map(msg => msg.textContent);
            const blob = new Blob([messages.join('\n')], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `messages-${new Date().toISOString().slice(0, 19)}.txt`;
            a.click();
            
            URL.revokeObjectURL(url);
            addMessage('info', 'Mensajes exportados');
        }
        
        // Alert and notification system
        function showAlert(message, type = 'info', duration = 3000) {
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            
            // Add appropriate icon based on type
            const icons = {
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è',
                'info': '‚ÑπÔ∏è'
            };
            
            alert.innerHTML = `${icons[type] || 'üìù'} ${message}`;
            document.body.appendChild(alert);
            
            // Auto remove after duration
            setTimeout(() => {
                alert.style.animation = 'slideOut 0.3s ease forwards';
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.parentNode.removeChild(alert);
                    }
                }, 300);
            }, duration);
        }
        
        // Enhanced error handling with better user feedback
        function handleUserAction(action, requiredState = 'authenticated') {
            if (requiredState === 'connected' && !connected) {
                showAlert('Debe conectarse al servidor primero. Haga clic en "Conectar".', 'warning');
                return false;
            }
            
            if (requiredState === 'authenticated' && !authenticated) {
                showAlert('Debe autenticarse primero. Ingrese su token y haga clic en "Iniciar Sesi√≥n".', 'warning');
                return false;
            }
            
            return true;
        }
        
        // Add helpful tooltips to form elements
        function addFormTooltips() {
            // Add tooltips to input fields
            document.getElementById('token').setAttribute('data-tooltip', 'Ingrese su token de equipo proporcionado por el profesor (formato: TK-XXXX)');
            document.getElementById('sim-qty').setAttribute('data-tooltip', 'Cantidad de unidades para la orden (n√∫mero entero positivo)');
            document.getElementById('sim-price').setAttribute('data-tooltip', 'Precio por unidad en d√≥lares (ejemplo: 10.50)');
            document.getElementById('prod-qty').setAttribute('data-tooltip', 'Cantidad a producir para simulaci√≥n (n√∫mero entero positivo)');
            document.getElementById('offer-qty').setAttribute('data-tooltip', 'Cantidad solicitada en la oferta');
            document.getElementById('offer-max-price').setAttribute('data-tooltip', 'Precio m√°ximo que est√° dispuesto a pagar');
            
            // Make form elements use tooltip class
            ['token', 'sim-qty', 'sim-price', 'prod-qty', 'offer-qty', 'offer-max-price'].forEach(id => {
                document.getElementById(id).className += ' tooltip';
            });
        }
        
        // Enhanced connection status updates
        function updateConnectionStatus(status, details = '') {
            const statusEl = document.getElementById('status-indicator');
            const connectionTimeEl = document.getElementById('connection-time');
            
            switch(status) {
                case 'connecting':
                    statusEl.textContent = 'Conectando...';
                    statusEl.className = 'status-indicator status-connecting';
                    showAlert('Estableciendo conexi√≥n con el servidor...', 'info');
                    break;
                case 'connected':
                    statusEl.textContent = 'Conectado';
                    statusEl.className = 'status-indicator status-connected';
                    connectionTimeEl.textContent = `Conectado: ${new Date().toLocaleTimeString()}`;
                    showAlert('Conexi√≥n establecida exitosamente. Ahora puede iniciar sesi√≥n.', 'success');
                    break;
                case 'authenticated':
                    statusEl.textContent = `Autenticado: ${details}`;
                    statusEl.className = 'status-indicator status-authenticated';
                    showAlert(`Autenticaci√≥n exitosa como ${details}. Todas las funciones est√°n disponibles.`, 'success');
                    break;
                case 'disconnected':
                    statusEl.textContent = 'Desconectado';
                    statusEl.className = 'status-indicator status-disconnected';
                    connectionTimeEl.textContent = '';
                    showAlert('Conexi√≥n perdida. Intente reconectar.', 'error');
                    break;
            }
        }
        
        // Button state management with better feedback
        function updateButtonStates() {
            const buttons = [
                { id: 'login-btn', requires: 'connected', reason: 'Debe conectarse al servidor primero' },
                { id: 'create-order-btn', requires: 'authenticated', reason: 'Debe autenticarse para crear √≥rdenes' },
                { id: 'prod-btn', requires: 'authenticated', reason: 'Debe autenticarse para simular producci√≥n' },
                { id: 'send-offer-btn', requires: 'authenticated', reason: 'Debe autenticarse para enviar ofertas' },
                { id: 'place-order-btn', requires: 'authenticated', reason: 'Debe autenticarse para realizar √≥rdenes' },
                { id: 'ping-btn', requires: 'connected', reason: 'Debe estar conectado para enviar ping' },
                { id: 'resync-btn', requires: 'authenticated', reason: 'Debe autenticarse para solicitar resincronizaci√≥n' }
            ];
            
            buttons.forEach(btn => {
                const element = document.getElementById(btn.id);
                if (element) {
                    const shouldEnable = (btn.requires === 'connected' && connected) || 
                                       (btn.requires === 'authenticated' && authenticated);
                    
                    element.disabled = !shouldEnable;
                    element.setAttribute('data-disabled-reason', shouldEnable ? '' : btn.reason);
                }
            });
        }
        
        // Enhanced message display with categories
        function addMessage(type, message, showAlert = false) {
            const msg = document.createElement('div');
            msg.className = `message ${type}`;
            msg.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            messageList.appendChild(msg);
            messageList.scrollTop = messageList.scrollHeight;
            
            // Show alert for important messages
            if (showAlert || type === 'error') {
                showAlert(message, type === 'error' ? 'error' : type === 'success' ? 'success' : 'info');
            }
            
            // Auto-scroll to messages tab for errors
            if (type === 'error') {
                const messagesTab = document.querySelector('[onclick="switchRightTab(\'messages\')"]');
                if (messagesTab && !messagesTab.classList.contains('active')) {
                    messagesTab.style.background = 'rgba(231, 76, 60, 0.5)';
                    setTimeout(() => {
                        messagesTab.style.background = '';
                    }, 2000);
                }
            }
        }
        
        // Enhanced form validation with user feedback
        function validateForm(formType) {
            let isValid = true;
            let errors = [];
            
            switch(formType) {
                case 'login':
                    const token = document.getElementById('token').value.trim();
                    if (!token) {
                        errors.push('El token es requerido');
                        isValid = false;
                    } else if (!token.startsWith('TK-')) {
                        errors.push('El token debe comenzar con "TK-"');
                        isValid = false;
                    }
                    break;
                    
                case 'order':
                    const qty = parseInt(document.getElementById('qty').value);
                    const price = parseFloat(document.getElementById('price').value);
                    const mode = document.getElementById('mode').value;
                    
                    if (!qty || qty <= 0) {
                        errors.push('La cantidad debe ser un n√∫mero positivo');
                        isValid = false;
                    }
                    
                    if (mode === 'LIMIT' && (!price || price <= 0)) {
                        errors.push('El precio debe ser un n√∫mero positivo para √≥rdenes l√≠mite');
                        isValid = false;
                    }
                    break;
                    
                case 'market-order':
                    const simQty = parseInt(document.getElementById('sim-qty').value);
                    const simPrice = parseFloat(document.getElementById('sim-price').value);
                    
                    if (!simQty || simQty <= 0) {
                        errors.push('La cantidad debe ser un n√∫mero positivo');
                        isValid = false;
                    }
                    
                    if (!simPrice || simPrice <= 0) {
                        errors.push('El precio debe ser un n√∫mero positivo');
                        isValid = false;
                    }
                    break;
            }
            
            if (!isValid) {
                showAlert(`Errores de validaci√≥n: ${errors.join(', ')}`, 'error');
            }
            
            return isValid;
        }
        
        // Enhanced button enabling
        function enableDebugButtons() {
            document.getElementById('prod-btn').disabled = false;
            document.getElementById('all-orders-btn').disabled = false;
            document.getElementById('order-book-btn').disabled = false;
            document.getElementById('ping-btn').disabled = false;
            document.getElementById('resync-btn').disabled = false;
            document.getElementById('sessions-btn').disabled = false;
            document.getElementById('place-order-btn').disabled = false;
            document.getElementById('create-order-btn').disabled = false;
            document.getElementById('send-offer-btn').disabled = false;
            document.getElementById('quick-buy-fosfo').disabled = false;
            document.getElementById('quick-sell-fosfo').disabled = false;
            document.getElementById('quick-buy-pita').disabled = false;
            document.getElementById('quick-sell-pita').disabled = false;
            document.getElementById('refresh-orders-btn').disabled = false;
            document.getElementById('cancel-all-btn').disabled = false;
            
            // Error injection buttons
            document.getElementById('err-balance-btn').disabled = false;
            document.getElementById('err-product-btn').disabled = false;
            document.getElementById('err-disconnect-btn').disabled = false;
            document.getElementById('err-expire-btn').disabled = false;
        }
    </script>
</body>
</html>